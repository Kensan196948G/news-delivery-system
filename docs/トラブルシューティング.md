# 🔧 トラブルシューティング

## 📋 **よくある問題と解決方法**

このドキュメントでは、ニュース配信システムでよく発生する問題とその解決方法を体系的に説明します。

---

## 🚨 **緊急度別問題分類**

### **🔴 緊急 (Critical) - 即座対応**
- システム完全停止
- 配信完全失敗（3回連続）
- セキュリティ侵害検知
- データベース破損

### **🟡 警告 (Warning) - 2時間以内対応**
- 配信部分失敗
- API制限到達
- パフォーマンス大幅低下
- ディスク容量不足

### **🟢 情報 (Info) - 1営業日以内対応**
- 個別記事取得失敗
- 翻訳品質低下
- キャッシュミス増加
- ログ容量増加

---

## 📧 **配信関連の問題**

### **配信完全失敗**

#### **症状**
- メールが全く送信されない
- エラーログに「SMTP connection failed」
- 「Authentication failed」エラー

#### **診断手順**
```bash
# 1. Gmail接続テスト
python -c "
import smtplib
import ssl
from email.mime.text import MIMEText

try:
    # SMTP接続テスト
    context = ssl.create_default_context()
    server = smtplib.SMTP('smtp.gmail.com', 587)
    server.starttls(context=context)
    
    # 認証テスト（環境変数から取得）
    import os
    email = os.getenv('GMAIL_USER')
    password = os.getenv('GMAIL_APP_PASSWORD')
    
    if not email or not password:
        print('❌ 環境変数未設定: GMAIL_USER または GMAIL_APP_PASSWORD')
    else:
        server.login(email, password)
        print('✅ Gmail接続・認証成功')
    
    server.quit()
    
except smtplib.SMTPAuthenticationError:
    print('❌ 認証失敗: App Passwordを確認してください')
except smtplib.SMTPConnectError:
    print('❌ 接続失敗: ネットワーク接続を確認してください')
except Exception as e:
    print(f'❌ その他のエラー: {e}')
"

# 2. 環境変数確認
echo \"GMAIL_USER: $GMAIL_USER\"
echo \"GMAIL_APP_PASSWORD: $(echo $GMAIL_APP_PASSWORD | sed 's/./*/g')\"

# 3. 設定ファイル確認
cat config/config.json | jq '.delivery'
```

#### **解決方法**

**A. App Password関連**
```bash
# 1. 新しいApp Password生成
# Google Account → セキュリティ → 2段階認証 → アプリパスワード

# 2. 環境変数更新
nano .env
# GMAIL_APP_PASSWORD=新しいパスワード

# 3. 設定再読み込み
source .env

# 4. テスト実行
python src/main.py --mode test-email
```

**B. ネットワーク関連**
```bash
# 1. DNS解決確認
nslookup smtp.gmail.com

# 2. ポート接続確認
telnet smtp.gmail.com 587

# 3. ファイアウォール確認
sudo ufw status
sudo iptables -L | grep 587

# 4. プロキシ設定確認（必要に応じて）
echo $http_proxy
echo $https_proxy
```

**C. Gmail設定関連**
```bash
# 1. 2段階認証確認
# Google Account で2段階認証が有効か確認

# 2. 「安全性の低いアプリ」設定
# 2024年以降は使用不可 - App Passwordを使用

# 3. IMAP/SMTP有効化確認
# Gmail設定 → 転送とPOP/IMAP → IMAP有効化
```

### **配信部分失敗**

#### **症状**
- 一部の配信は成功するが、失敗もある
- 「Temporary failure in name resolution」
- 断続的なSMTPエラー

#### **診断・解決手順**
```bash
# 1. 失敗パターン分析
grep "配信失敗" logs/delivery_$(date +%Y%m).log | tail -10

# 2. リトライ機能確認
python -c "
import json
with open('config/config.json', 'r') as f:
    config = json.load(f)
    print('リトライ設定:', config.get('delivery', {}).get('retry', {}))
"

# 3. レート制限確認
grep -E "(rate limit|429)" logs/system_$(date +%Y%m).log

# 4. 手動リトライ
python src/main.py --mode retry-failed
```

### **メール内容の問題**

#### **文字化け**
```bash
# 1. エンコーディング確認
file -i data/reports/latest.html

# 2. テンプレート確認
head -20 templates/email_template.html | grep charset

# 3. 修正実行
sed -i 's/charset=iso-8859-1/charset=UTF-8/g' templates/email_template.html
```

#### **HTML表示崩れ**
```bash
# 1. HTMLバリデーション
python -c "
from bs4 import BeautifulSoup
with open('data/reports/latest.html', 'r') as f:
    soup = BeautifulSoup(f.read(), 'html.parser')
    print('HTML構造確認:', 'OK' if soup.find('html') else 'NG')
"

# 2. CSS確認
grep -n "<style>" data/reports/latest.html

# 3. テンプレート再生成
python src/generators/html_generator.py --regenerate
```

---

## 🔗 **API関連の問題**

### **NewsAPI エラー**

#### **API Key無効**
```bash
# 1. APIキー確認
curl -X GET "https://newsapi.org/v2/top-headlines?country=jp&apiKey=$NEWSAPI_KEY"

# 2. 使用量確認
curl -X GET "https://newsapi.org/v2/usage?apiKey=$NEWSAPI_KEY"

# 3. 新しいキー取得・設定
# https://newsapi.org/account
```

#### **レート制限超過**
```bash
# 1. 使用量確認
sqlite3 data/news.db "
SELECT 
    COUNT(*) as requests,
    DATE(created_at) as date
FROM api_usage 
WHERE api_name = 'newsapi' 
AND DATE(created_at) >= DATE('now', '-1 day')
GROUP BY DATE(created_at);"

# 2. キャッシュ活用設定
python -c "
import json
with open('config/config.json', 'r') as f:
    config = json.load(f)
    config['cache']['newsapi_ttl'] = 7200  # 2時間キャッシュ
with open('config/config.json', 'w') as f:
    json.dump(config, f, indent=2)
"

# 3. 収集頻度調整
# crontab の実行間隔を調整
crontab -e
```

### **DeepL API エラー**

#### **翻訳品質低下**
```bash
# 1. API使用量確認
curl -X POST "https://api-free.deepl.com/v2/usage" \
     -H "Authorization: DeepL-Auth-Key $DEEPL_API_KEY"

# 2. 翻訳テスト
python -c "
import requests
data = {
    'text': 'Hello, world!',
    'target_lang': 'JA',
    'source_lang': 'EN'
}
headers = {'Authorization': f'DeepL-Auth-Key $DEEPL_API_KEY'}
response = requests.post('https://api-free.deepl.com/v2/translate', data=data, headers=headers)
print('翻訳テスト:', response.json())
"

# 3. 代替翻訳設定（必要に応じて）
python scripts/setup_backup_translator.py
```

#### **字数制限超過**
```bash
# 1. 月次使用量確認
python scripts/check_deepl_usage.py --month $(date +%Y-%m)

# 2. 翻訳対象文字数制限
python -c "
import json
with open('config/config.json', 'r') as f:
    config = json.load(f)
    config['translation']['max_chars_per_article'] = 1000
with open('config/config.json', 'w') as f:
    json.dump(config, f, indent=2)
"
```

### **Claude API エラー**

#### **分析失敗**
```bash
# 1. APIキー確認
python -c "
import anthropic
try:
    client = anthropic.Client(api_key='$ANTHROPIC_API_KEY')
    print('Claude API接続: OK')
except Exception as e:
    print(f'Claude API接続: FAILED - {e}')
"

# 2. トークン使用量確認
grep "token" logs/system_$(date +%Y%m).log | tail -10

# 3. 簡易分析モードに切替
python -c "
import json
with open('config/config.json', 'r') as f:
    config = json.load(f)
    config['ai_analysis']['fallback_mode'] = True
with open('config/config.json', 'w') as f:
    json.dump(config, f, indent=2)
"
```

---

## 💾 **データベース関連の問題**

### **データベース破損**

#### **症状**
- 「database disk image is malformed」
- SQLiteエラー
- データ取得失敗

#### **診断・修復手順**
```bash
# 1. データベース整合性チェック
sqlite3 data/news.db "PRAGMA integrity_check;"

# 2. データベース情報確認
sqlite3 data/news.db ".dbinfo"

# 3. バックアップから復旧
cp backup/db/news_$(date +%Y%m%d).db data/news.db

# 4. 復旧確認
sqlite3 data/news.db "SELECT COUNT(*) FROM articles;"

# 5. 緊急時：新規データベース作成
python scripts/init_database.py --force
```

### **パフォーマンス問題**

#### **クエリ実行遅延**
```bash
# 1. データベースサイズ確認
ls -lh data/news.db
sqlite3 data/news.db ".dbinfo"

# 2. インデックス確認
sqlite3 data/news.db ".indices"

# 3. データベース最適化
sqlite3 data/news.db "VACUUM; ANALYZE;"

# 4. 古いデータ削除
python scripts/cleanup_old_articles.py --older-than 90
```

#### **ディスク容量不足**
```bash
# 1. 容量確認
df -h
du -sh data/

# 2. 大きなファイル確認
find data/ -size +10M -ls

# 3. ログローテーション
logrotate -f /etc/logrotate.d/news-delivery-system

# 4. 緊急クリーンアップ
rm -f logs/*.log.*.gz
find cache/ -mtime +7 -delete
```

---

## ⚙️ **システム関連の問題**

### **高CPU使用率**

#### **診断手順**
```bash
# 1. プロセス確認
top -p $(pgrep -f "python.*main.py")
ps aux | grep python | sort -k3 -nr

# 2. 並行処理数確認
python -c "
import json
with open('config/config.json', 'r') as f:
    config = json.load(f)
    print('並行数設定:', config.get('performance', {}))
"

# 3. 処理時間分析
grep "処理時間" logs/system_$(date +%Y%m).log | tail -10
```

#### **解決方法**
```bash
# 1. 並行処理数削減
python -c "
import json
with open('config/config.json', 'r') as f:
    config = json.load(f)
config.setdefault('performance', {})['max_workers'] = 3
with open('config/config.json', 'w') as f:
    json.dump(config, f, indent=2)
"

# 2. プロセス優先度調整
renice +10 $(pgrep -f "python.*main.py")

# 3. スケジュール調整
crontab -e
# 実行間隔を調整（例：12時間おき）
```

### **メモリ不足**

#### **診断・解決**
```bash
# 1. メモリ使用量確認
free -h
ps aux --sort=-%mem | head -10

# 2. Python プロセスのメモリ使用量
python -c "
import psutil
import os
process = psutil.Process()
print(f'メモリ使用量: {process.memory_info().rss / 1024 / 1024:.2f} MB')
"

# 3. メモリリーク確認
valgrind --tool=memcheck python src/main.py --mode test

# 4. ガベージコレクション強制実行
python -c "import gc; gc.collect(); print('ガベージコレクション実行')"

# 5. バッチサイズ削減
python -c "
import json
with open('config/config.json', 'r') as f:
    config = json.load(f)
config.setdefault('processing', {})['batch_size'] = 25
with open('config/config.json', 'w') as f:
    json.dump(config, f, indent=2)
"
```

### **ネットワーク問題**

#### **接続タイムアウト**
```bash
# 1. ネットワーク接続確認
ping -c 4 8.8.8.8
curl -I https://api.newsapi.org/

# 2. DNS確認
nslookup newsapi.org
dig newsapi.org

# 3. タイムアウト設定確認
python -c "
import json
with open('config/config.json', 'r') as f:
    config = json.load(f)
    print('タイムアウト設定:', config.get('network', {}))
"

# 4. タイムアウト値調整
python -c "
import json
with open('config/config.json', 'r') as f:
    config = json.load(f)
config.setdefault('network', {})['timeout'] = 30
with open('config/config.json', 'w') as f:
    json.dump(config, f, indent=2)
"
```

---

## 🔐 **セキュリティ関連の問題**

### **セキュリティアラート**

#### **脆弱性検出時**
```bash
# 1. 詳細確認
cat security-reports/latest-scan.json | jq '.vulnerabilities[]'

# 2. 影響範囲確認
safety check --json | jq '.[] | select(.vulnerability_id != null)'

# 3. 緊急更新実行
pip install --upgrade $(cat requirements.txt | grep -E "(requests|urllib3|cryptography)" | cut -d'=' -f1)

# 4. 再スキャン
safety check
bandit -r src/

# 5. 結果報告
./scripts/security_report.sh
```

#### **不審なアクセス**
```bash
# 1. アクセスログ確認
grep -E "(403|404|500)" logs/access_$(date +%Y%m).log

# 2. 失敗したログイン試行
grep "Authentication failed" logs/system_$(date +%Y%m).log

# 3. ファイル権限確認
find . -type f -perm /o+w
ls -la config/

# 4. 権限修正
chmod 600 config/config.json .env
chmod 755 scripts/*.sh
```

### **API キー漏洩疑い**

#### **緊急対応手順**
```bash
# 1. GitHub履歴確認
git log --oneline --all | grep -i "api\|key\|secret"

# 2. ファイル内容確認
grep -r "sk-\|api.*key" . --exclude-dir=.git

# 3. 新しいAPIキー生成
# 各サービスで新しいキー生成

# 4. 設定更新
nano config/config.json
nano .env

# 5. 古いキー無効化
# 各サービスで古いキー削除

# 6. Git履歴クリーンアップ（必要に応じて）
git filter-branch --tree-filter 'rm -f config/config.json.old' HEAD
```

---

## 🤖 **GitHub Actions関連の問題**

### **ワークフロー失敗**

#### **CI/CD パイプライン失敗**
```bash
# 1. 失敗原因確認
gh run list --status failure --limit 5
gh run view $(gh run list --limit 1 --json databaseId --jq '.[0].databaseId')

# 2. ローカル再現
python -m pytest tests/
python -m bandit -r src/
python -m safety check

# 3. 修正・再実行
git add .
git commit -m "fix: CI/CD issues"
git push origin main
```

#### **セキュリティスキャン失敗**
```bash
# 1. セキュリティレポート確認
gh api repos/Kensan196948G/news-delivery-system/code-scanning/alerts

# 2. ローカル修正
safety check --file requirements.txt
bandit -r src/ -f json

# 3. 修正適用
pip install --upgrade パッケージ名
git add requirements.txt
git commit -m "security: update vulnerable dependencies"
```

### **Dependabot エラー**

#### **依存関係更新失敗**
```bash
# 1. Dependabot PR確認
gh pr list --author "app/dependabot"

# 2. 競合解決
git checkout dependabot/pip/package-name
git rebase main
git push --force-with-lease

# 3. 手動マージ（必要に応じて）
gh pr merge PR番号 --merge
```

---

## 📊 **診断ツール・スクリプト**

### **総合診断スクリプト**
```bash
#!/bin/bash
# scripts/system_diagnosis.sh

echo "🔍 システム総合診断開始..."

# 基本システム情報
echo "📊 システム情報:"
uname -a
python3 --version
df -h
free -h

# サービス状況
echo "⚙️ サービス状況:"
systemctl status cron
ps aux | grep python

# 設定ファイル確認
echo "📋 設定確認:"
if [ -f config/config.json ]; then
    echo "✅ config.json 存在"
else
    echo "❌ config.json 不存在"
fi

if [ -f .env ]; then
    echo "✅ .env 存在"
else
    echo "❌ .env 不存在"
fi

# データベース確認
echo "💾 データベース確認:"
if [ -f data/news.db ]; then
    echo "✅ データベースファイル存在"
    sqlite3 data/news.db "SELECT COUNT(*) FROM articles;" 2>/dev/null && echo "✅ データベース正常" || echo "❌ データベースエラー"
else
    echo "❌ データベースファイル不存在"
fi

# ネットワーク確認
echo "🌐 ネットワーク確認:"
ping -c 1 google.com >/dev/null && echo "✅ インターネット接続OK" || echo "❌ インターネット接続NG"
curl -s -I https://newsapi.org/ >/dev/null && echo "✅ NewsAPI接続OK" || echo "❌ NewsAPI接続NG"

# ログ確認
echo "📝 ログ確認:"
if [ -d logs ]; then
    echo "ログファイル数: $(ls logs/*.log 2>/dev/null | wc -l)"
    echo "最新エラー数: $(grep -c ERROR logs/system_$(date +%Y%m).log 2>/dev/null || echo 0)"
fi

echo "🔍 診断完了"
```

### **パフォーマンス分析スクリプト**
```bash
#!/bin/bash
# scripts/performance_analysis.sh

echo "📈 パフォーマンス分析開始..."

# 処理時間分析
echo "⏱️ 処理時間分析:"
if [ -f logs/system_$(date +%Y%m).log ]; then
    grep "処理時間" logs/system_$(date +%Y%m).log | \
    awk '{print $NF}' | \
    awk '{sum+=$1; count++} END {print "平均処理時間:", sum/count "秒"}'
fi

# メモリ使用量
echo "💾 メモリ使用量:"
ps aux | grep "python.*main.py" | awk '{print "メモリ使用率:", $4"%"}'

# データベースサイズ
echo "🗄️ データベースサイズ:"
if [ -f data/news.db ]; then
    ls -lh data/news.db | awk '{print "データベースサイズ:", $5}'
fi

# API使用量
echo "🔗 API使用量 (当日):"
sqlite3 data/news.db "
SELECT 
    api_name,
    COUNT(*) as requests
FROM api_usage 
WHERE DATE(created_at) = DATE('now')
GROUP BY api_name;" 2>/dev/null

echo "📈 分析完了"
```

### **修復スクリプト**
```bash
#!/bin/bash
# scripts/auto_repair.sh

echo "🔧 自動修復開始..."

# 権限修復
echo "🔐 ファイル権限修復:"
chmod 600 config/config.json .env 2>/dev/null
chmod 755 scripts/*.sh 2>/dev/null
chmod 755 src/ data/ logs/ 2>/dev/null

# キャッシュクリーンアップ
echo "🧹 キャッシュクリーンアップ:"
find cache/ -name "*.json" -mtime +7 -delete 2>/dev/null
echo "期限切れキャッシュを削除しました"

# ログローテーション
echo "📝 ログローテーション:"
find logs/ -name "*.log" -size +100M -exec gzip {} \; 2>/dev/null
echo "大きなログファイルを圧縮しました"

# データベース最適化
echo "💾 データベース最適化:"
if [ -f data/news.db ]; then
    sqlite3 data/news.db "VACUUM; ANALYZE;" 2>/dev/null
    echo "データベースを最適化しました"
fi

# プロセス確認・修復
echo "⚙️ プロセス確認:"
if ! pgrep -f "python.*main.py" >/dev/null; then
    echo "メインプロセスが見つかりません（正常：スケジュール実行外）"
else
    echo "メインプロセスが実行中です"
fi

echo "🔧 自動修復完了"
```

---

## 📞 **サポート・エスカレーション**

### **問題報告テンプレート**
```
# 問題報告

## 基本情報
- 発生日時: YYYY/MM/DD HH:MM
- 緊急度: 緊急/警告/情報
- 影響範囲: 全体/部分/個別

## 症状
- 観測された問題:
- エラーメッセージ:
- 再現手順:

## 実施した対応
- 確認したこと:
- 試した解決方法:
- 結果:

## システム情報
- OS: 
- Python version:
- 関連ログ:
```

### **緊急連絡先**
- **GitHub Issues**: https://github.com/Kensan196948G/news-delivery-system/issues
- **システム管理者**: kensan1969@gmail.com

### **エスカレーション基準**
1. **即座エスカレーション**: システム完全停止、セキュリティ侵害
2. **2時間以内**: 配信失敗、重要機能停止
3. **1営業日以内**: パフォーマンス問題、設定変更要求

---

**🎯 適切なトラブルシューティングにより、システムの可用性と信頼性を維持できます！**