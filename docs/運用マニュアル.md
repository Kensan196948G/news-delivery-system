# 🛠️ 運用マニュアル

## 📋 **運用概要**

ニュース配信システムの日常運用、監視、メンテナンス手順を包括的に説明します。

### **運用体制**
- **自動運用**: 基本的に無人運用
- **監視レベル**: 定期確認 + アラート対応
- **対応時間**: 平日 9:00-18:00 (緊急時は24時間)
- **責任者**: システム管理者

---

## ⏰ **運用スケジュール**

### **自動実行スケジュール**

| 時刻 | 処理内容 | 所要時間 | 監視項目 |
|------|----------|----------|----------|
| **07:00** | 朝刊ニュース配信 | 5-8分 | 配信成功・記事数・エラー率 |
| **12:00** | 昼刊ニュース配信 | 5-8分 | 同上 |
| **18:00** | 夕刊ニュース配信 | 5-8分 | 同上 |
| **02:00** | セキュリティスキャン | 10-15分 | 脆弱性・セキュリティアラート |
| **03:00** | ログローテーション | 2-3分 | ディスク容量・ログ圧縮 |
| **04:00** | データベースメンテナンス | 5-10分 | DB最適化・インデックス再構築 |

### **手動実行スケジュール**

| 周期 | 作業内容 | 担当者 | 所要時間 |
|------|----------|--------|----------|
| **毎日** | システム状況確認 | 運用者 | 10分 |
| **毎週** | ログ分析・パフォーマンス確認 | 運用者 | 30分 |
| **毎月** | システムヘルスチェック | システム管理者 | 60分 |
| **四半期** | 設定見直し・改善提案 | システム管理者 | 120分 |

---

## 👀 **日常監視**

### **1. 配信状況監視**

#### **配信成功確認**
```bash
# 当日の配信ログ確認
tail -f logs/delivery_$(date +%Y%m).log

# 配信成功・失敗件数
grep "配信成功" logs/delivery_$(date +%Y%m).log | wc -l
grep "配信失敗" logs/delivery_$(date +%Y%m).log | wc -l

# 最新配信状況
./scripts/check_delivery_status.sh
```

#### **記事収集状況確認**
```bash
# 記事収集数確認
sqlite3 data/news.db "
SELECT 
    category,
    COUNT(*) as count,
    AVG(importance_score) as avg_importance
FROM articles 
WHERE DATE(collected_at) = DATE('now')
GROUP BY category;"

# 重要記事確認
sqlite3 data/news.db "
SELECT title, importance_score, category
FROM articles 
WHERE DATE(collected_at) = DATE('now')
AND importance_score >= 8
ORDER BY importance_score DESC;"
```

### **2. システムリソース監視**

#### **リソース使用状況**
```bash
# システムリソース確認
./scripts/system_monitor.sh

# 詳細確認
htop
iotop
df -h
free -h

# ログファイルサイズ確認
du -sh logs/
ls -lh logs/*.log | head -10
```

#### **プロセス監視**
```bash
# Python プロセス確認
ps aux | grep python
ps aux | grep news-delivery

# メモリ使用量確認
ps -o pid,ppid,cmd,%mem,%cpu --sort=-%mem | head

# ネットワーク接続確認
netstat -tulpn | grep python
```

### **3. エラー監視**

#### **エラーログ確認**
```bash
# 当日のエラー
grep "ERROR" logs/system_$(date +%Y%m).log

# 重要エラー
grep -E "(CRITICAL|FATAL)" logs/system_$(date +%Y%m).log

# API エラー
grep "API.*error" logs/system_$(date +%Y%m).log

# 最新エラー（直近1時間）
find logs/ -name "*.log" -mmin -60 -exec grep -l "ERROR\|CRITICAL" {} \; | xargs tail
```

#### **GitHub Actions監視**
```bash
# Actions 状況確認（GitHub CLI使用）
gh run list --limit 10

# 失敗したワークフロー確認
gh run list --status failure --limit 5

# セキュリティスキャン結果
gh run view --log $(gh run list --workflow="Security Automation" --limit 1 --json databaseId --jq '.[0].databaseId')
```

---

## 🚨 **アラート対応**

### **重要度別対応フロー**

#### **🔴 緊急 (Critical)**
- **対象**: システム停止、配信完全失敗、セキュリティ侵害
- **対応時間**: 30分以内
- **手順**:
  1. 即座にシステム状況確認
  2. 応急対応実施
  3. 根本原因調査
  4. 恒久対策実施
  5. 再発防止策検討

#### **🟡 警告 (Warning)**
- **対象**: 配信部分失敗、パフォーマンス低下、API制限
- **対応時間**: 2時間以内
- **手順**:
  1. 症状確認・影響範囲調査
  2. 一時対応実施
  3. 監視強化
  4. 必要に応じて恒久対策

#### **🟢 情報 (Info)**
- **対象**: 設定変更通知、定期メンテナンス
- **対応時間**: 1営業日以内
- **手順**:
  1. 内容確認
  2. 必要に応じて対応
  3. ログ記録

### **具体的なトラブル対応**

#### **配信失敗時の対応**
```bash
# 1. 配信失敗原因確認
grep "配信失敗" logs/delivery_$(date +%Y%m).log | tail -5

# 2. Gmail接続確認
python -c "
import smtplib
try:
    server = smtplib.SMTP('smtp.gmail.com', 587)
    server.starttls()
    print('Gmail connection: OK')
    server.quit()
except Exception as e:
    print(f'Gmail connection: FAILED - {e}')
"

# 3. 手動配信テスト
python src/main.py --mode test-delivery

# 4. 必要に応じて手動配信
python src/main.py --mode emergency --recipient kensan1969@gmail.com
```

#### **API制限エラー対応**
```bash
# 1. API使用量確認
sqlite3 data/news.db "
SELECT 
    api_name,
    COUNT(*) as requests,
    DATE(created_at) as date
FROM api_usage 
WHERE DATE(created_at) >= DATE('now', '-7 days')
GROUP BY api_name, DATE(created_at)
ORDER BY date DESC, requests DESC;"

# 2. キャッシュクリア（必要に応じて）
rm -rf cache/api/*

# 3. 代替API使用（設定変更）
# config/config.json で無効化されたAPIを有効化
```

#### **セキュリティアラート対応**
```bash
# 1. 脆弱性情報確認
cat security-reports/latest-scan.json | jq '.vulnerabilities[]'

# 2. 依存関係更新
pip install --upgrade safety bandit
pip list --outdated

# 3. セキュリティパッチ適用
# 該当パッケージを個別更新

# 4. 再スキャン実行
safety check
bandit -r src/
```

---

## 🔧 **定期メンテナンス**

### **日次メンテナンス**

#### **朝の確認作業**
```bash
# システム稼働確認
./scripts/daily_check.sh

# 前日の配信結果確認
./scripts/check_yesterday_delivery.sh

# ディスク使用量確認
df -h
du -sh data/ logs/ cache/

# エラーログ確認
grep -c "ERROR" logs/system_$(date +%Y%m).log
```

#### **夕方の確認作業**
```bash
# 当日の処理結果サマリー
./scripts/daily_summary.sh

# システムパフォーマンス確認
./scripts/performance_check.sh

# バックアップ状況確認
ls -la backup/ | tail -5
```

### **週次メンテナンス**

#### **毎週日曜日実行**
```bash
# 1. ログ分析
./scripts/weekly_log_analysis.sh

# 2. データベース最適化
sqlite3 data/news.db "VACUUM; ANALYZE;"

# 3. 古いデータクリーンアップ
python scripts/cleanup_old_data.py --days 30

# 4. キャッシュクリーンアップ
find cache/ -name "*.json" -mtime +7 -delete

# 5. バックアップ検証
./scripts/verify_backups.sh
```

### **月次メンテナンス**

#### **毎月第1日曜日実行**
```bash
# 1. システムヘルスチェック
./scripts/monthly_health_check.sh

# 2. API使用量レポート
python scripts/api_usage_report.py --month $(date +%Y-%m)

# 3. パフォーマンス分析
python scripts/performance_analysis.py --month $(date +%Y-%m)

# 4. セキュリティ監査
./scripts/security_audit.sh

# 5. 設定ファイル検証
python scripts/config_validator.py
```

---

## 📊 **監視ダッシュボード**

### **システム状況の確認方法**

#### **WebベースGitHub Actions**
- **URL**: https://github.com/Kensan196948G/news-delivery-system/actions
- **確認項目**:
  - ワークフロー実行状況
  - セキュリティスキャン結果
  - テスト実行結果
  - 依存関係更新状況

#### **コマンドライン監視**
```bash
# リアルタイム監視
watch -n 30 './scripts/system_status.sh'

# ダッシュボード表示
./scripts/dashboard.sh

# メトリクス表示
./scripts/show_metrics.sh
```

### **主要メトリクス**

#### **配信メトリクス**
- 配信成功率 (目標: 98%以上)
- 平均処理時間 (目標: 8分以内)
- 記事収集数 (目標: 80記事以上/回)
- 重要記事発見率 (重要度8以上の記事)

#### **システムメトリクス**
- CPU使用率 (警告: 70%、危険: 85%)
- メモリ使用率 (警告: 80%、危険: 90%)
- ディスク使用率 (警告: 85%、危険: 95%)
- エラー率 (警告: 5%、危険: 10%)

#### **API メトリクス**
- API応答時間 (目標: 2秒以内)
- API成功率 (目標: 95%以上)
- キャッシュヒット率 (目標: 70%以上)
- レート制限使用率 (警告: 80%、危険: 95%)

---

## 🔄 **バックアップ・復旧**

### **バックアップ戦略**

#### **自動バックアップ**
```bash
# フルバックアップ (30分おき)
0,30 * * * * cd /mnt/Linux-ExHDD/news-delivery-system && ./scripts/full_backup.sh

# データベースバックアップ (毎日 2:00)
0 2 * * * cd /mnt/Linux-ExHDD/news-delivery-system && ./scripts/db_backup.sh

# 設定ファイルバックアップ (毎週)
0 3 * * 0 cd /mnt/Linux-ExHDD/news-delivery-system && ./scripts/config_backup.sh
```

#### **バックアップ検証**
```bash
# バックアップ整合性確認
./scripts/verify_backup_integrity.sh

# 復旧テスト
./scripts/test_restore.sh --dry-run

# バックアップ一覧
ls -la /mnt/Linux-ExHDD/news-delivery-system-BackUp/
```

### **災害復旧手順**

#### **完全復旧シナリオ**
```bash
# 1. 最新バックアップから復旧
./scripts/full_restore.sh --backup-date 20241210

# 2. 依存関係再インストール
pip install -r requirements.txt

# 3. 設定ファイル復旧
cp backup/config/config.json.20241210 config/config.json

# 4. データベース復旧
sqlite3 data/news.db < backup/db/news_20241210.sql

# 5. 動作確認
python src/main.py --mode test

# 6. サービス再開
./scripts/setup_cron.sh
```

#### **部分復旧シナリオ**
```bash
# データベースのみ復旧
./scripts/restore_database.sh --date 20241210

# 設定ファイルのみ復旧
./scripts/restore_config.sh --date 20241210

# ログファイル復旧
./scripts/restore_logs.sh --date-range 20241201-20241210
```

---

## 📈 **パフォーマンス最適化**

### **定期最適化作業**

#### **データベース最適化**
```bash
# インデックス再構築
sqlite3 data/news.db "REINDEX;"

# 統計情報更新
sqlite3 data/news.db "ANALYZE;"

# 不要データ削除
python scripts/cleanup_old_articles.py --older-than 90

# データベースサイズ確認
sqlite3 data/news.db ".dbinfo"
```

#### **キャッシュ最適化**
```bash
# キャッシュ効率確認
python scripts/cache_analysis.py

# 期限切れキャッシュ削除
find cache/ -name "*.json" -type f -exec python scripts/check_cache_expiry.py {} \;

# キャッシュサイズ最適化
du -sh cache/
find cache/ -name "*.json" -size +10M -ls
```

#### **ログ最適化**
```bash
# ログローテーション確認
logrotate -d /etc/logrotate.d/news-delivery-system

# 古いログ圧縮
find logs/ -name "*.log" -mtime +7 -exec gzip {} \;

# ログサイズ確認
du -sh logs/
ls -lSh logs/ | head -10
```

---

## 🎯 **運用改善**

### **継続的改善プロセス**

#### **月次改善レビュー**
1. **パフォーマンス分析**
   - 処理時間トレンド分析
   - エラー率分析
   - API使用効率分析

2. **品質改善**
   - 記事品質評価
   - 翻訳精度確認
   - AI分析精度確認

3. **運用効率化**
   - 手動作業の自動化
   - 監視項目の見直し
   - アラート閾値の調整

#### **改善提案の実装**
```bash
# 新機能のテスト環境での検証
git checkout -b feature/improvement-test
# 実装・テスト

# 段階的リリース
git checkout develop
git merge feature/improvement-test
# 開発環境でテスト

git checkout main
git merge develop
# 本番環境へのデプロイ
```

### **ユーザーフィードバック対応**

#### **記事品質改善**
- 重要度評価の精度向上
- カテゴリ分類の改善
- 要約品質の向上
- 翻訳精度の向上

#### **配信形式改善**
- HTML テンプレートの改善
- PDF レイアウトの最適化
- モバイル対応の改善
- 読みやすさの向上

---

## 📋 **運用チェックリスト**

### **日次チェックリスト**
- [ ] 朝・昼・夕の配信成功確認
- [ ] エラーログ確認（重要エラーなし）
- [ ] システムリソース確認（正常範囲内）
- [ ] GitHub Actions 実行状況確認
- [ ] 重要記事の確認（緊急対応不要）

### **週次チェックリスト**
- [ ] 週間配信統計の確認
- [ ] パフォーマンスメトリクスの確認
- [ ] バックアップ状況の確認
- [ ] セキュリティスキャン結果の確認
- [ ] API使用量の確認

### **月次チェックリスト**
- [ ] 月間運用レポート作成
- [ ] システムヘルスチェック実施
- [ ] セキュリティ監査実施
- [ ] 設定ファイル検証
- [ ] 改善提案の検討・実装

---

## 🆘 **緊急時対応**

### **緊急連絡先**
- **システム管理者**: kensan1969@gmail.com
- **GitHub Repository**: https://github.com/Kensan196948G/news-delivery-system
- **GitHub Issues**: https://github.com/Kensan196948G/news-delivery-system/issues

### **緊急停止手順**
```bash
# 1. Cron停止
crontab -r

# 2. 実行中プロセス停止
pkill -f "python.*main.py"

# 3. 状況確認・報告
./scripts/emergency_report.sh

# 4. 復旧準備
./scripts/prepare_recovery.sh
```

### **緊急復旧手順**
```bash
# 1. 最新バックアップから復旧
./scripts/emergency_restore.sh

# 2. 最小構成での再開
./scripts/minimal_startup.sh

# 3. 段階的機能復旧
./scripts/gradual_recovery.sh

# 4. 完全復旧確認
./scripts/full_recovery_check.sh
```

---

**🎯 適切な運用により、99%以上の稼働率と高品質なニュース配信を実現できます！**