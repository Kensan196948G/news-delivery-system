# ⚙️ 設定リファレンス

## 📋 **設定ファイル概要**

ニュース配信システムの全設定項目、形式、デフォルト値について詳細に説明します。

### **設定ファイル構造**
```
config/
├── config.json              # メイン設定ファイル
├── config.json.example      # 設定テンプレート
└── .env                     # 環境変数（機密情報）
```

---

## 🔧 **メイン設定ファイル (config.json)**

### **完全設定例**
```json
{
  "system": {
    "version": "1.0.0",
    "name": "ニュース配信システム",
    "timezone": "Asia/Tokyo",
    "language": "ja",
    "debug": false,
    "max_workers": 5,
    "timeout": 30
  },
  "paths": {
    "data_root": "./data",
    "logs": "./logs",
    "cache": "./cache",
    "backup": "./backup",
    "templates": "./templates"
  },
  "api": {
    "newsapi": {
      "enabled": true,
      "base_url": "https://newsapi.org/v2",
      "timeout": 30,
      "rate_limit": 1000,
      "rate_window": 86400
    },
    "deepl": {
      "enabled": true,
      "base_url": "https://api-free.deepl.com/v2",
      "timeout": 30,
      "max_chars_per_request": 1000,
      "monthly_limit": 500000
    },
    "anthropic": {
      "enabled": true,
      "model": "claude-3-sonnet-20240229",
      "timeout": 60,
      "max_tokens": 1000,
      "daily_limit": 1000
    },
    "gnews": {
      "enabled": true,
      "base_url": "https://gnews.io/api/v4",
      "timeout": 30,
      "rate_limit": 100,
      "rate_window": 86400
    },
    "nvd": {
      "enabled": true,
      "base_url": "https://services.nvd.nist.gov/rest/json/cves/2.0",
      "timeout": 30
    }
  },
  "collection": {
    "categories": {
      "domestic_social": {
        "enabled": true,
        "count": 10,
        "priority": 1,
        "keywords": ["政治", "経済", "社会"],
        "exclude_keywords": ["芸能", "スポーツ"],
        "sources": ["nhk.or.jp", "asahi.com", "mainichi.jp"]
      },
      "international_social": {
        "enabled": true,
        "count": 15,
        "priority": 2,
        "keywords": ["human rights", "social justice", "migration"],
        "exclude_keywords": ["sports", "entertainment"],
        "sources": ["bbc.co.uk", "reuters.com", "ap.org"]
      },
      "domestic_economy": {
        "enabled": true,
        "count": 8,
        "priority": 3,
        "keywords": ["株価", "為替", "金融"],
        "sources": ["nikkei.com", "bloomberg.co.jp"]
      },
      "international_economy": {
        "enabled": true,
        "count": 15,
        "priority": 4,
        "keywords": ["market", "economy", "trade", "inflation"],
        "sources": ["bloomberg.com", "reuters.com", "ft.com"]
      },
      "tech": {
        "enabled": true,
        "count": 20,
        "priority": 5,
        "keywords": ["AI", "machine learning", "cloud", "blockchain"],
        "exclude_keywords": ["gaming"],
        "sources": ["techcrunch.com", "arstechnica.com", "wired.com"]
      },
      "security": {
        "enabled": true,
        "count": 20,
        "priority": 6,
        "keywords": ["cybersecurity", "vulnerability", "ransomware"],
        "alert_threshold": 9.0,
        "cvss_threshold": 7.0,
        "sources": ["krebsonsecurity.com", "threatpost.com"]
      }
    },
    "global_settings": {
      "max_articles_per_run": 100,
      "deduplication": true,
      "quality_filter": true,
      "min_content_length": 100
    }
  },
  "translation": {
    "enabled": true,
    "target_language": "JA",
    "source_languages": ["EN", "auto"],
    "formality": "default",
    "preserve_formatting": true,
    "max_chars_per_article": 2000,
    "cache_translations": true,
    "cache_ttl": 86400
  },
  "ai_analysis": {
    "enabled": true,
    "model_config": {
      "temperature": 0.1,
      "max_tokens": 1000,
      "top_p": 0.9
    },
    "analysis_settings": {
      "summary_length": "200-250文字",
      "importance_scale": "1-10",
      "keywords_count": 5,
      "sentiment_analysis": true,
      "category_classification": true
    },
    "processing": {
      "priority_threshold": 7,
      "max_priority_articles": 20,
      "parallel_processing": 5,
      "timeout": 120
    },
    "fallback": {
      "enabled": true,
      "simple_analysis": true,
      "keyword_extraction": true
    }
  },
  "report_generation": {
    "formats": ["html", "pdf"],
    "html": {
      "template": "email_template.html",
      "responsive_design": true,
      "embed_css": true,
      "include_images": false
    },
    "pdf": {
      "enabled": true,
      "page_size": "A4",
      "margins": "0.75in",
      "font_family": "Arial, sans-serif",
      "font_size": "11pt"
    },
    "content": {
      "include_summary": true,
      "include_statistics": true,
      "include_urgent_alerts": true,
      "max_articles_per_category": 10,
      "show_source_links": true
    }
  },
  "delivery": {
    "enabled": true,
    "schedule": ["07:00", "12:00", "18:00"],
    "recipients": [
      {
        "email": "kensan1969@gmail.com",
        "name": "システム管理者",
        "categories": ["all"],
        "format": "html"
      }
    ],
    "sender": {
      "name": "ニュース配信システム",
      "email": "system@example.com"
    },
    "email_settings": {
      "subject_format": "{time_icon} {edition}ニュース配信 - {date} {time}",
      "retry_attempts": 3,
      "retry_delay": 60,
      "timeout": 30
    },
    "urgent_notification": {
      "enabled": true,
      "importance_threshold": 10,
      "cvss_threshold": 9.0,
      "immediate_delivery": true,
      "subject_prefix": "【緊急】"
    }
  },
  "database": {
    "type": "sqlite",
    "path": "./data/news.db",
    "backup_enabled": true,
    "backup_schedule": "daily",
    "retention_days": 90,
    "vacuum_schedule": "weekly",
    "connection_pool": {
      "max_connections": 10,
      "timeout": 30
    }
  },
  "cache": {
    "enabled": true,
    "type": "file",
    "ttl": {
      "api_responses": 3600,
      "translations": 86400,
      "analysis": 604800,
      "deduplication": 2592000
    },
    "cleanup": {
      "schedule": "daily",
      "max_size": "1GB",
      "retention_days": 30
    }
  },
  "logging": {
    "level": "INFO",
    "format": "[{time}] [{level}] [{module}] {message}",
    "rotation": {
      "max_file_size": "10MB",
      "backup_count": 5,
      "rotation_schedule": "daily"
    },
    "destinations": {
      "file": true,
      "console": true,
      "email": false
    },
    "sensitive_data_masking": true
  },
  "monitoring": {
    "enabled": true,
    "metrics": {
      "performance": true,
      "errors": true,
      "api_usage": true,
      "system_resources": true
    },
    "alerts": {
      "email": "kensan1969@gmail.com",
      "thresholds": {
        "error_rate": 0.05,
        "response_time": 30,
        "cpu_usage": 0.8,
        "memory_usage": 0.9,
        "disk_usage": 0.9
      }
    },
    "health_check": {
      "interval": 300,
      "endpoint": "/health",
      "timeout": 10
    }
  },
  "security": {
    "encryption": {
      "enabled": true,
      "algorithm": "AES-256",
      "key_rotation": "monthly"
    },
    "access_control": {
      "ip_whitelist": [],
      "rate_limiting": true,
      "request_timeout": 30
    },
    "audit": {
      "enabled": true,
      "log_level": "INFO",
      "retention_days": 365
    }
  },
  "performance": {
    "concurrent_requests": 10,
    "request_timeout": 30,
    "retry_policy": {
      "max_attempts": 3,
      "base_delay": 1,
      "max_delay": 60,
      "exponential_backoff": true
    },
    "connection_pooling": {
      "enabled": true,
      "max_connections": 20,
      "keep_alive": 30
    }
  },
  "experimental": {
    "features": {
      "advanced_deduplication": false,
      "multilingual_analysis": false,
      "real_time_alerts": false
    }
  }
}
```

---

## 🔑 **環境変数設定 (.env)**

### **必須環境変数**
```bash
# API認証情報
NEWSAPI_KEY=your-newsapi-key-here
DEEPL_API_KEY=your-deepl-api-key-here
ANTHROPIC_API_KEY=your-claude-api-key-here
GNEWS_API_KEY=your-gnews-api-key-here

# Gmail設定
GMAIL_USER=your-email@gmail.com
GMAIL_APP_PASSWORD=your-16-char-app-password

# データベース設定
DATABASE_URL=sqlite:///./data/news.db

# セキュリティ設定
SECRET_KEY=your-secret-key-for-encryption
HASH_SALT=your-hash-salt

# 外部サービス設定（オプション）
WEBHOOK_URL=https://your-webhook-endpoint.com
SLACK_WEBHOOK_URL=https://hooks.slack.com/your-webhook

# 開発・デバッグ設定
DEBUG=false
LOG_LEVEL=INFO
ENVIRONMENT=production
```

### **環境変数詳細説明**

#### **API認証**
| 変数名 | 必須 | 説明 | 形式例 |
|--------|------|------|--------|
| `NEWSAPI_KEY` | ✅ | NewsAPI認証キー | `a1b2c3d4e5f6...` (32文字) |
| `DEEPL_API_KEY` | ✅ | DeepL API認証キー | `12345678-1234-1234-1234-123456789012:fx` |
| `ANTHROPIC_API_KEY` | ✅ | Claude API認証キー | `sk-ant-api03-...` |
| `GNEWS_API_KEY` | ⚪ | GNews API認証キー | `a1b2c3d4e5f6...` |

#### **Gmail設定**
| 変数名 | 必須 | 説明 | 取得方法 |
|--------|------|------|---------|
| `GMAIL_USER` | ✅ | 送信元Gmailアドレス | Googleアカウント |
| `GMAIL_APP_PASSWORD` | ✅ | アプリパスワード | Google 2段階認証設定 |

---

## 📊 **設定項目詳細**

### **システム設定 (system)**

#### **基本設定**
```json
{
  "system": {
    "version": "1.0.0",              // バージョン番号
    "name": "ニュース配信システム",    // システム名
    "timezone": "Asia/Tokyo",        // タイムゾーン
    "language": "ja",                // 表示言語
    "debug": false,                  // デバッグモード
    "max_workers": 5,                // 最大並行ワーカー数
    "timeout": 30                    // デフォルトタイムアウト(秒)
  }
}
```

#### **パス設定 (paths)**
```json
{
  "paths": {
    "data_root": "./data",           // データベース・記事保存先
    "logs": "./logs",                // ログファイル保存先
    "cache": "./cache",              // キャッシュファイル保存先
    "backup": "./backup",            // バックアップ保存先
    "templates": "./templates"       // HTMLテンプレート保存先
  }
}
```

### **API設定 (api)**

#### **NewsAPI設定**
```json
{
  "newsapi": {
    "enabled": true,                 // API有効化
    "base_url": "https://newsapi.org/v2",  // ベースURL
    "timeout": 30,                   // タイムアウト(秒)
    "rate_limit": 1000,              // レート制限(リクエスト/日)
    "rate_window": 86400,            // レート制限ウィンドウ(秒)
    "endpoints": {
      "everything": "/everything",    // 検索エンドポイント
      "top_headlines": "/top-headlines"  // ヘッドラインエンドポイント
    }
  }
}
```

#### **DeepL API設定**
```json
{
  "deepl": {
    "enabled": true,
    "base_url": "https://api-free.deepl.com/v2",  // 無料版URL
    // "base_url": "https://api.deepl.com/v2",    // Pro版URL
    "timeout": 30,
    "max_chars_per_request": 1000,   // 1リクエストあたり最大文字数
    "monthly_limit": 500000,         // 月間文字数制限
    "formality": "default",          // 敬語レベル: default/more/less
    "preserve_formatting": true      // フォーマット保持
  }
}
```

#### **Claude API設定**
```json
{
  "anthropic": {
    "enabled": true,
    "model": "claude-3-sonnet-20240229",  // 使用モデル
    "timeout": 60,
    "max_tokens": 1000,              // 最大トークン数
    "daily_limit": 1000,             // 日次制限
    "temperature": 0.1,              // 創造性パラメータ
    "top_p": 0.9                     // サンプリングパラメータ
  }
}
```

### **収集設定 (collection)**

#### **カテゴリ設定詳細**
```json
{
  "domestic_social": {
    "enabled": true,                 // カテゴリ有効化
    "count": 10,                     // 収集記事数
    "priority": 1,                   // 優先度(1が最高)
    "keywords": ["政治", "経済"],     // 必須キーワード
    "exclude_keywords": ["芸能"],     // 除外キーワード
    "sources": ["nhk.or.jp"],        // 優先ソース
    "language": "ja",                // 言語指定
    "country": "jp",                 // 国指定
    "sort_by": "relevancy",          // ソート順: relevancy/popularity/publishedAt
    "from_date": "2024-01-01",       // 開始日(省略可)
    "to_date": null                  // 終了日(省略可)
  }
}
```

### **翻訳設定 (translation)**

#### **翻訳パラメータ**
```json
{
  "translation": {
    "enabled": true,
    "target_language": "JA",         // 翻訳先言語
    "source_languages": ["EN", "auto"],  // 翻訳元言語
    "formality": "default",          // 敬語レベル
    "preserve_formatting": true,     // フォーマット保持
    "max_chars_per_article": 2000,   // 記事あたり最大文字数
    "cache_translations": true,      // 翻訳結果キャッシュ
    "cache_ttl": 86400,             // キャッシュ保持時間(秒)
    "batch_size": 50,               // バッチサイズ
    "parallel_requests": 3           // 並行リクエスト数
  }
}
```

### **AI分析設定 (ai_analysis)**

#### **分析パラメータ**
```json
{
  "ai_analysis": {
    "enabled": true,
    "model_config": {
      "temperature": 0.1,            // 創造性(0.0-1.0)
      "max_tokens": 1000,            // 最大トークン数
      "top_p": 0.9,                  // サンプリング確率
      "frequency_penalty": 0.0,      // 頻度ペナルティ
      "presence_penalty": 0.0        // 存在ペナルティ
    },
    "analysis_settings": {
      "summary_length": "200-250文字",  // 要約文字数
      "importance_scale": "1-10",     // 重要度スケール
      "keywords_count": 5,            // 抽出キーワード数
      "sentiment_analysis": true,     // センチメント分析有効化
      "category_classification": true, // カテゴリ分類有効化
      "urgency_detection": true       // 緊急度判定有効化
    }
  }
}
```

### **配信設定 (delivery)**

#### **配信スケジュール**
```json
{
  "delivery": {
    "enabled": true,
    "schedule": ["07:00", "12:00", "18:00"],  // 配信時刻
    "timezone": "Asia/Tokyo",        // タイムゾーン
    "weekend_delivery": true,        // 週末配信
    "holiday_delivery": false,       // 祝日配信
    "recipients": [
      {
        "email": "user@example.com",
        "name": "ユーザー名",
        "categories": ["all"],        // 配信カテゴリ
        "format": "html",            // 配信形式
        "language": "ja",            // 言語
        "timezone": "Asia/Tokyo"     // タイムゾーン
      }
    ]
  }
}
```

#### **緊急通知設定**
```json
{
  "urgent_notification": {
    "enabled": true,
    "importance_threshold": 10,      // 重要度閾値
    "cvss_threshold": 9.0,          // CVSSスコア閾値
    "immediate_delivery": true,      // 即座配信
    "subject_prefix": "【緊急】",    // 件名プレフィックス
    "recipients": ["admin@example.com"],  // 緊急通知先
    "retry_attempts": 5,            // リトライ回数
    "retry_delay": 300              // リトライ間隔(秒)
  }
}
```

---

## 🔧 **設定の検証と管理**

### **設定検証スクリプト**
```python
# scripts/config_validator.py
import json
import os
from pathlib import Path
from typing import Dict, List, Any

class ConfigValidator:
    """設定ファイル検証"""
    
    def __init__(self, config_path: str = "config/config.json"):
        self.config_path = Path(config_path)
        self.errors = []
        self.warnings = []
        
    def validate_config(self) -> Dict[str, Any]:
        """設定ファイル総合検証"""
        
        result = {
            "valid": True,
            "errors": [],
            "warnings": [],
            "checks": {
                "file_exists": False,
                "json_valid": False,
                "required_fields": False,
                "field_types": False,
                "field_values": False,
                "env_vars": False
            }
        }
        
        # 1. ファイル存在確認
        if not self.config_path.exists():
            result["errors"].append(f"設定ファイルが存在しません: {self.config_path}")
            return result
        result["checks"]["file_exists"] = True
        
        # 2. JSON形式確認
        try:
            with open(self.config_path, 'r', encoding='utf-8') as f:
                config = json.load(f)
        except json.JSONDecodeError as e:
            result["errors"].append(f"JSON形式エラー: {e}")
            return result
        result["checks"]["json_valid"] = True
        
        # 3. 必須フィールド確認
        required_fields = [
            "system", "api", "collection", "delivery"
        ]
        for field in required_fields:
            if field not in config:
                result["errors"].append(f"必須フィールド不足: {field}")
        result["checks"]["required_fields"] = len(result["errors"]) == 0
        
        # 4. フィールド型確認
        type_checks = [
            ("system.version", str),
            ("system.max_workers", int),
            ("collection.categories", dict),
            ("delivery.schedule", list)
        ]
        
        for field_path, expected_type in type_checks:
            if not self._check_field_type(config, field_path, expected_type):
                result["errors"].append(f"型エラー: {field_path} は {expected_type.__name__} である必要があります")
        
        # 5. 値範囲確認
        value_checks = [
            ("system.max_workers", lambda x: 1 <= x <= 20),
            ("system.timeout", lambda x: 5 <= x <= 300),
            ("delivery.schedule", lambda x: len(x) > 0)
        ]
        
        for field_path, validator in value_checks:
            value = self._get_field_value(config, field_path)
            if value is not None and not validator(value):
                result["warnings"].append(f"値範囲警告: {field_path} = {value}")
        
        # 6. 環境変数確認
        env_vars = ["NEWSAPI_KEY", "DEEPL_API_KEY", "ANTHROPIC_API_KEY", "GMAIL_USER"]
        for var in env_vars:
            if not os.getenv(var):
                result["warnings"].append(f"環境変数未設定: {var}")
        
        result["valid"] = len(result["errors"]) == 0
        result["errors"] = result["errors"]
        result["warnings"] = result["warnings"]
        
        return result
    
    def _check_field_type(self, config: dict, field_path: str, expected_type: type) -> bool:
        """フィールド型チェック"""
        value = self._get_field_value(config, field_path)
        return value is not None and isinstance(value, expected_type)
    
    def _get_field_value(self, config: dict, field_path: str) -> Any:
        """ネストしたフィールド値取得"""
        keys = field_path.split('.')
        value = config
        
        for key in keys:
            if isinstance(value, dict) and key in value:
                value = value[key]
            else:
                return None
                
        return value

# 使用例
if __name__ == "__main__":
    validator = ConfigValidator()
    result = validator.validate_config()
    
    if result["valid"]:
        print("✅ 設定ファイルは有効です")
    else:
        print("❌ 設定ファイルにエラーがあります:")
        for error in result["errors"]:
            print(f"  - {error}")
    
    if result["warnings"]:
        print("⚠️ 警告:")
        for warning in result["warnings"]:
            print(f"  - {warning}")
```

### **設定管理コマンド**
```bash
# 設定検証
python scripts/config_validator.py

# 設定テンプレート生成
python scripts/generate_config_template.py

# 設定バックアップ
cp config/config.json backup/config_$(date +%Y%m%d_%H%M%S).json

# 設定復元
cp backup/config_20241210_120000.json config/config.json

# 環境変数確認
python scripts/check_env_vars.py

# 設定差分確認
diff config/config.json config/config.json.example
```

---

## 🔄 **動的設定変更**

### **ホットリロード対応**
```python
# src/utils/config_manager.py
import json
import os
from pathlib import Path
from typing import Dict, Any, Callable
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

class ConfigManager:
    """動的設定管理"""
    
    def __init__(self, config_path: str = "config/config.json"):
        self.config_path = Path(config_path)
        self.config = {}
        self.callbacks = []
        self.observer = None
        
        self.load_config()
        self.start_watching()
    
    def load_config(self) -> Dict[str, Any]:
        """設定ファイル読み込み"""
        try:
            with open(self.config_path, 'r', encoding='utf-8') as f:
                self.config = json.load(f)
                
            # 環境変数による上書き
            self._apply_env_overrides()
            
            return self.config
            
        except Exception as e:
            print(f"設定読み込みエラー: {e}")
            return {}
    
    def get(self, key: str, default: Any = None) -> Any:
        """設定値取得"""
        keys = key.split('.')
        value = self.config
        
        for k in keys:
            if isinstance(value, dict) and k in value:
                value = value[k]
            else:
                return default
                
        return value
    
    def set(self, key: str, value: Any) -> None:
        """設定値設定"""
        keys = key.split('.')
        config = self.config
        
        for k in keys[:-1]:
            if k not in config:
                config[k] = {}
            config = config[k]
            
        config[keys[-1]] = value
        self.save_config()
    
    def save_config(self) -> None:
        """設定ファイル保存"""
        try:
            with open(self.config_path, 'w', encoding='utf-8') as f:
                json.dump(self.config, f, indent=2, ensure_ascii=False)
        except Exception as e:
            print(f"設定保存エラー: {e}")
    
    def add_change_callback(self, callback: Callable) -> None:
        """変更コールバック追加"""
        self.callbacks.append(callback)
    
    def start_watching(self) -> None:
        """ファイル監視開始"""
        class ConfigChangeHandler(FileSystemEventHandler):
            def __init__(self, manager):
                self.manager = manager
                
            def on_modified(self, event):
                if event.src_path == str(self.manager.config_path):
                    print("設定ファイル変更を検出、再読み込みします")
                    old_config = self.manager.config.copy()
                    self.manager.load_config()
                    
                    # コールバック実行
                    for callback in self.manager.callbacks:
                        callback(old_config, self.manager.config)
        
        self.observer = Observer()
        self.observer.schedule(
            ConfigChangeHandler(self),
            str(self.config_path.parent),
            recursive=False
        )
        self.observer.start()
    
    def _apply_env_overrides(self) -> None:
        """環境変数による設定上書き"""
        env_mappings = {
            'DEBUG': 'system.debug',
            'LOG_LEVEL': 'logging.level',
            'MAX_WORKERS': 'system.max_workers',
            'TIMEOUT': 'system.timeout'
        }
        
        for env_var, config_path in env_mappings.items():
            env_value = os.getenv(env_var)
            if env_value:
                # 型変換
                if env_var in ['DEBUG']:
                    env_value = env_value.lower() in ['true', '1', 'yes']
                elif env_var in ['MAX_WORKERS', 'TIMEOUT']:
                    env_value = int(env_value)
                    
                self._set_nested_value(config_path, env_value)
    
    def _set_nested_value(self, path: str, value: Any) -> None:
        """ネストした設定値設定"""
        keys = path.split('.')
        config = self.config
        
        for key in keys[:-1]:
            if key not in config:
                config[key] = {}
            config = config[key]
            
        config[keys[-1]] = value
```

---

## 📋 **設定チェックリスト**

### **初期セットアップ**
- [ ] `config.json` をテンプレートからコピー
- [ ] 全API キーを取得・設定
- [ ] Gmail App Password 設定
- [ ] パス設定の確認（ディレクトリ存在）
- [ ] タイムゾーン設定確認
- [ ] 配信先メールアドレス設定

### **セキュリティ確認**
- [ ] `.env` ファイルの権限 (600)
- [ ] `config.json` の権限確認
- [ ] `.gitignore` にシークレット追加
- [ ] 環境変数の暗号化確認
- [ ] バックアップの暗号化設定

### **パフォーマンス最適化**
- [ ] 並行処理数の最適化
- [ ] タイムアウト値の調整
- [ ] キャッシュ設定の最適化
- [ ] レート制限の設定確認
- [ ] バッチサイズの調整

### **運用準備**
- [ ] ログローテーション設定
- [ ] 監視閾値の設定
- [ ] アラート通知先設定
- [ ] バックアップスケジュール確認
- [ ] ヘルスチェック設定

---

**⚙️ 適切な設定により、システムの安定性とパフォーマンスを最大化できます！**