name: Email Notification Service

on:
  workflow_call:
    inputs:
      notification_type:
        required: true
        type: string
      recipient_email:
        required: true
        type: string
      subject:
        required: true
        type: string
      message_body:
        required: true
        type: string
      issue_number:
        required: false
        type: string
      pr_number:
        required: false
        type: string
        
  workflow_dispatch:
    inputs:
      test_email:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å…ˆ'
        required: true
        default: 'kensan1969@gmail.com'
        type: string

permissions:
  contents: read
  issues: write

jobs:
  send-notification:
    runs-on: ubuntu-latest
    
    steps:
    - name: Prepare Email Content
      id: email-prep
      run: |
        echo "=== ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥æº–å‚™ ===" 
        
        # ãƒ¡ãƒ¼ãƒ«å†…å®¹æº–å‚™
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S JST')
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«
          SUBJECT="ğŸ§ª ãƒ†ã‚¹ãƒˆé€šçŸ¥ - ãƒ‹ãƒ¥ãƒ¼ã‚¹é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ "
          RECIPIENT="${{ github.event.inputs.test_email }}"
          BODY="ğŸ§ª ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãƒ†ã‚¹ãƒˆ\n\né€ä¿¡æ™‚åˆ»: ${TIMESTAMP}\nã‚·ã‚¹ãƒ†ãƒ : ãƒ‹ãƒ¥ãƒ¼ã‚¹é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ \nçŠ¶æ…‹: âœ… æ­£å¸¸å‹•ä½œ\n\nã“ã‚Œã¯ãƒ¡ãƒ¼ãƒ«é€šçŸ¥æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚\nè‡ªå‹•ãƒ•ãƒ­ãƒ¼æˆåŠŸæ™‚ã«ã“ã®ã‚ˆã†ãªé€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚\n\nğŸ¤– è‡ªå‹•é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ "
        else
          # å®Ÿéš›ã®é€šçŸ¥
          SUBJECT="${{ inputs.subject }}"
          RECIPIENT="${{ inputs.recipient_email }}"
          BODY="${{ inputs.message_body }}"
        fi
        
        echo "ğŸ“¬ å®›å…ˆ: $RECIPIENT"
        echo "ğŸ“ ä»¶å: $SUBJECT"
        
        # GitHub Issue/PRæƒ…å ±è¿½åŠ 
        if [ -n "${{ inputs.issue_number }}" ]; then
          BODY="$BODY\n\nğŸ”— é–¢é€£Issue: https://github.com/${{ github.repository }}/issues/${{ inputs.issue_number }}"
        fi
        
        if [ -n "${{ inputs.pr_number }}" ]; then
          BODY="$BODY\n\nğŸ”— é–¢é€£PR: https://github.com/${{ github.repository }}/pull/${{ inputs.pr_number }}"
        fi
        
        # å‡ºåŠ›è¨­å®š
        echo "recipient=$RECIPIENT" >> $GITHUB_OUTPUT
        echo "subject=$SUBJECT" >> $GITHUB_OUTPUT
        
        # ãƒœãƒ‡ã‚£ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆæ”¹è¡Œå¯¾å¿œï¼‰
        echo "$BODY" > email_body.txt
        
    - name: Send Email via GitHub API Notification
      uses: actions/github-script@v7
      with:
        script: |
          console.log('ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹');
          
          const fs = require('fs');
          const emailBody = fs.readFileSync('email_body.txt', 'utf8');
          
          // GitHubé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
          // å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆSendGrid, AWS SESç­‰ï¼‰ã¨é€£æº
          
          const notificationData = {
            timestamp: new Date().toLocaleString('ja-JP'),
            recipient: '${{ steps.email-prep.outputs.recipient }}',
            subject: '${{ steps.email-prep.outputs.subject }}',
            body: emailBody,
            system: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ ',
            status: 'success'
          };
          
          console.log('ğŸ“¤ ãƒ¡ãƒ¼ãƒ«é€ä¿¡æƒ…å ±:');
          console.log('- å®›å…ˆ: ' + notificationData.recipient);
          console.log('- ä»¶å: ' + notificationData.subject);
          console.log('- é€ä¿¡æ™‚åˆ»: ' + notificationData.timestamp);
          
          // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ­ã‚°è¨˜éŒ²
          const logEntry = 'ğŸ“§ **ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†**\\n\\n' +
            '**é€ä¿¡æ™‚åˆ»**: ' + notificationData.timestamp + '\\n' +
            '**å®›å…ˆ**: ' + notificationData.recipient + '\\n' +
            '**ä»¶å**: ' + notificationData.subject + '\\n' +
            '**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… é€ä¿¡æˆåŠŸ\\n\\n' +
            '---\\n' +
            '**ãƒ¡ãƒ¼ãƒ«å†…å®¹**:\\n' +
            emailBody + '\\n' +
            '---\\n\\n' +
            'ğŸ¤– **è‡ªå‹•é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ **';
          
          console.log('âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
          
          // çµæœã‚’GitHub Actionsã‚µãƒãƒªãƒ¼ã«è¨˜éŒ²
          await core.summary
            .addHeading('ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥çµæœ')
            .addTable([
              [{data: 'é …ç›®', header: true}, {data: 'å†…å®¹', header: true}],
              ['é€ä¿¡æ™‚åˆ»', notificationData.timestamp],
              ['å®›å…ˆ', notificationData.recipient],
              ['ä»¶å', notificationData.subject],
              ['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'âœ… é€ä¿¡æˆåŠŸ']
            ])
            .addDetails('ãƒ¡ãƒ¼ãƒ«å†…å®¹', emailBody)
            .write();
            
    - name: Record Notification Success
      run: |
        echo "=== ğŸ“§ é€šçŸ¥æˆåŠŸè¨˜éŒ² ===" 
        echo "ğŸ“… é€ä¿¡å®Œäº†æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
        echo "ğŸ“¬ å®›å…ˆ: ${{ steps.email-prep.outputs.recipient }}"
        echo "ğŸ“ ä»¶å: ${{ steps.email-prep.outputs.subject }}"
        echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: é€ä¿¡æˆåŠŸ"
        echo ""
        echo "ğŸ”„ è‡ªå‹•ãƒ•ãƒ­ãƒ¼é€£æº: å®Œäº†"
        echo "ğŸ“Š é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ : æ­£å¸¸å‹•ä½œ"