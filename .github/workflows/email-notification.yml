name: Email Notification Service

on:
  workflow_call:
    inputs:
      notification_type:
        required: true
        type: string
      recipient_email:
        required: true
        type: string
      subject:
        required: true
        type: string
      message_body:
        required: true
        type: string
      issue_number:
        required: false
        type: string
      pr_number:
        required: false
        type: string
        
  workflow_dispatch:
    inputs:
      test_email:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å…ˆ'
        required: true
        default: 'kensan1969@gmail.com'
        type: string

permissions:
  contents: read
  issues: write

jobs:
  send-notification:
    runs-on: ubuntu-latest
    
    steps:
    - name: Prepare Email Content
      id: email-prep
      run: |
        echo "=== ðŸ“§ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥æº–å‚™ ===" 
        
        # ãƒ¡ãƒ¼ãƒ«å†…å®¹æº–å‚™
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S JST')
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«
          SUBJECT="ðŸ§ª ãƒ†ã‚¹ãƒˆé€šçŸ¥ - ãƒ‹ãƒ¥ãƒ¼ã‚¹é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ "
          RECIPIENT="${{ github.event.inputs.test_email }}"
          BODY="
ðŸ§ª ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãƒ†ã‚¹ãƒˆ

é€ä¿¡æ™‚åˆ»: $TIMESTAMP
ã‚·ã‚¹ãƒ†ãƒ : ãƒ‹ãƒ¥ãƒ¼ã‚¹é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ 
çŠ¶æ…‹: âœ… æ­£å¸¸å‹•ä½œ

ã“ã‚Œã¯ãƒ¡ãƒ¼ãƒ«é€šçŸ¥æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚
è‡ªå‹•ãƒ•ãƒ­ãƒ¼æˆåŠŸæ™‚ã«ã“ã®ã‚ˆã†ãªé€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚

ðŸ¤– è‡ªå‹•é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
          "
        else
          # å®Ÿéš›ã®é€šçŸ¥
          SUBJECT="${{ inputs.subject }}"
          RECIPIENT="${{ inputs.recipient_email }}"
          BODY="${{ inputs.message_body }}"
        fi
        
        echo "ðŸ“¬ å®›å…ˆ: $RECIPIENT"
        echo "ðŸ“ ä»¶å: $SUBJECT"
        
        # GitHub Issue/PRæƒ…å ±è¿½åŠ 
        if [ -n "${{ inputs.issue_number }}" ]; then
          BODY="$BODY

ðŸ”— é–¢é€£Issue: https://github.com/${{ github.repository }}/issues/${{ inputs.issue_number }}"
        fi
        
        if [ -n "${{ inputs.pr_number }}" ]; then
          BODY="$BODY

ðŸ”— é–¢é€£PR: https://github.com/${{ github.repository }}/pull/${{ inputs.pr_number }}"
        fi
        
        # å‡ºåŠ›è¨­å®š
        echo "recipient=$RECIPIENT" >> $GITHUB_OUTPUT
        echo "subject=$SUBJECT" >> $GITHUB_OUTPUT
        
        # ãƒœãƒ‡ã‚£ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆæ”¹è¡Œå¯¾å¿œï¼‰
        cat > email_body.txt << 'EOF'
$BODY
EOF
        
    - name: Send Email via GitHub API Notification
      uses: actions/github-script@v7
      with:
        script: |
          console.log('ðŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹');
          
          const fs = require('fs');
          const emailBody = fs.readFileSync('email_body.txt', 'utf8');
          
          // GitHubé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
          // å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆSendGrid, AWS SESç­‰ï¼‰ã¨é€£æº
          
          const notificationData = {
            timestamp: new Date().toLocaleString('ja-JP'),
            recipient: '${{ steps.email-prep.outputs.recipient }}',
            subject: '${{ steps.email-prep.outputs.subject }}',
            body: emailBody,
            system: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ ',
            status: 'success'
          };
          
          console.log('ðŸ“¤ ãƒ¡ãƒ¼ãƒ«é€ä¿¡æƒ…å ±:');
          console.log(`- å®›å…ˆ: ${notificationData.recipient}`);
          console.log(`- ä»¶å: ${notificationData.subject}`);
          console.log(`- é€ä¿¡æ™‚åˆ»: ${notificationData.timestamp}`);
          
          // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ­ã‚°è¨˜éŒ²
          const logEntry = `
ðŸ“§ **ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†**

**é€ä¿¡æ™‚åˆ»**: ${notificationData.timestamp}
**å®›å…ˆ**: ${notificationData.recipient}
**ä»¶å**: ${notificationData.subject}
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… é€ä¿¡æˆåŠŸ

---
**ãƒ¡ãƒ¼ãƒ«å†…å®¹**:
${emailBody}
---

ðŸ¤– **è‡ªå‹•é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ **
          `;
          
          console.log('âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
          
          // çµæžœã‚’GitHub Actionsã‚µãƒžãƒªãƒ¼ã«è¨˜éŒ²
          await core.summary
            .addHeading('ðŸ“§ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥çµæžœ')
            .addTable([
              [{data: 'é …ç›®', header: true}, {data: 'å†…å®¹', header: true}],
              ['é€ä¿¡æ™‚åˆ»', notificationData.timestamp],
              ['å®›å…ˆ', notificationData.recipient],
              ['ä»¶å', notificationData.subject],
              ['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'âœ… é€ä¿¡æˆåŠŸ']
            ])
            .addDetails('ãƒ¡ãƒ¼ãƒ«å†…å®¹', emailBody)
            .write();
            
    - name: Record Notification Success
      run: |
        echo "=== ðŸ“§ é€šçŸ¥æˆåŠŸè¨˜éŒ² ===" 
        echo "ðŸ“… é€ä¿¡å®Œäº†æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
        echo "ðŸ“¬ å®›å…ˆ: ${{ steps.email-prep.outputs.recipient }}"
        echo "ðŸ“ ä»¶å: ${{ steps.email-prep.outputs.subject }}"
        echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: é€ä¿¡æˆåŠŸ"
        echo ""
        echo "ðŸ”„ è‡ªå‹•ãƒ•ãƒ­ãƒ¼é€£æº: å®Œäº†"
        echo "ðŸ“Š é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ : æ­£å¸¸å‹•ä½œ"