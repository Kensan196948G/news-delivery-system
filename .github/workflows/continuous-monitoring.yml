name: Continuous Monitoring

on:
  schedule:
    # 1æ™‚é–“ãŠãã«å®Ÿè¡Œ (æ–°ä»•æ§˜: 1æ™‚é–“ä»¥å†…æ¤œçŸ¥ä¿è¨¼)
    - cron: '0 * * * *'
    # å®Œå…¨è‡ªå‹•ãƒ•ãƒ­ãƒ¼ã¨é€£æº
  
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
    inputs:
      check_type:
        description: 'ç›£è¦–ã‚¿ã‚¤ãƒ—é¸æŠ'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - security
        - health
        - backup

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

jobs:
  continuous-health-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install monitoring dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml python-dotenv
        
    - name: System Health Check
      id: health-check
      run: |
        echo "=== ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆ$(date '+%Y-%m-%d %H:%M:%S JST')ï¼‰===" 
        
        # GitHubãƒªãƒã‚¸ãƒˆãƒªçµ±è¨ˆ
        echo "## ãƒªãƒã‚¸ãƒˆãƒªçµ±è¨ˆ" >> health-report.md
        echo "- å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')" >> health-report.md
        echo "- ã‚³ãƒŸãƒƒãƒˆæ•°: $(git rev-list --count HEAD)" >> health-report.md
        echo "- ãƒ–ãƒ©ãƒ³ãƒæ•°: $(git branch -r | wc -l)" >> health-report.md
        echo "" >> health-report.md
        
        # ãƒ•ã‚¡ã‚¤ãƒ«å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
        echo "## ãƒ•ã‚¡ã‚¤ãƒ«å¥å…¨æ€§" >> health-report.md
        
        # é‡è¦è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        critical_files=(
          "requirements.txt"
          "requirements-minimal.txt" 
          ".github/workflows/ci-cd.yml"
          "src/main.py"
          "docs/ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦.md"
        )
        
        missing_files=()
        for file in "${critical_files[@]}"; do
          if [ -f "$file" ]; then
            echo "- âœ… $file: å­˜åœ¨" >> health-report.md
          else
            echo "- âŒ $file: ä¸è¶³" >> health-report.md
            missing_files+=("$file")
          fi
        done
        
        # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
        echo "" >> health-report.md
        echo "## ä¾å­˜é–¢ä¿‚çŠ¶æ…‹" >> health-report.md
        if [ -f "requirements.txt" ]; then
          total_deps=$(grep -c "^[^#]" requirements.txt || echo "0")
          echo "- ç·ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ•°: $total_deps" >> health-report.md
        fi
        
        # å¥å…¨æ€§ã‚¹ã‚³ã‚¢è¨ˆç®—
        if [ ${#missing_files[@]} -eq 0 ]; then
          echo "HEALTH_STATUS=HEALTHY" >> $GITHUB_ENV
          echo "- ğŸŸ¢ **ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: æ­£å¸¸**" >> health-report.md
        else
          echo "HEALTH_STATUS=WARNING" >> $GITHUB_ENV
          echo "- ğŸŸ¡ **ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: æ³¨æ„ãŒå¿…è¦**" >> health-report.md
        fi
        
        cat health-report.md
        
    - name: Quick Security Scan
      if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'security' || github.event.schedule
      run: |
        echo "=== ã‚¯ã‚¤ãƒƒã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ ===" 
        
        # Safety - æ—¢çŸ¥ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆé«˜é€Ÿï¼‰
        pip install safety
        safety check --short-report --json > safety-quick.json || echo "è„†å¼±æ€§æ¤œå‡ºã¾ãŸã¯ç¢ºèªå®Œäº†"
        
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        echo "## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯çµæœ" >> health-report.md
        echo "- Safetyå®Ÿè¡Œ: âœ…" >> health-report.md
        echo "- å®Ÿè¡Œæ™‚åˆ»: $(date '+%H:%M JST')" >> health-report.md
        
        # å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
        if grep -r "password.*=" . --include="*.py" --exclude-dir=".git" | head -5; then
          echo "- âš ï¸ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã®å¯èƒ½æ€§ã‚’æ¤œå‡º" >> health-report.md
        else
          echo "- âœ… æ˜ã‚‰ã‹ãªèªè¨¼æƒ…å ±ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãªã—" >> health-report.md
        fi
        
    - name: Backup Status Check
      if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'backup' || github.event.schedule
      run: |
        echo "=== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çŠ¶æ…‹ç¢ºèª ===" 
        
        echo "" >> health-report.md
        echo "## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çŠ¶æ…‹" >> health-report.md
        echo "- æœ€çµ‚ãƒã‚§ãƒƒã‚¯: $(date '+%Y-%m-%d %H:%M JST')" >> health-report.md
        
        # Gitã‚³ãƒŸãƒƒãƒˆçŠ¶æ…‹ç¢ºèª
        last_commit=$(git log -1 --format="%h - %s (%cr)")
        echo "- æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ: $last_commit" >> health-report.md
        
        # ãƒªãƒ¢ãƒ¼ãƒˆåŒæœŸçŠ¶æ…‹
        git fetch origin main
        local_commits=$(git rev-list HEAD --count)
        remote_commits=$(git rev-list origin/main --count)
        
        if [ "$local_commits" -eq "$remote_commits" ]; then
          echo "- ğŸŸ¢ ãƒªãƒ¢ãƒ¼ãƒˆåŒæœŸ: æœ€æ–°" >> health-report.md
        else
          echo "- ğŸŸ¡ ãƒªãƒ¢ãƒ¼ãƒˆåŒæœŸ: å·®åˆ†ã‚ã‚Š (ãƒ­ãƒ¼ã‚«ãƒ«:$local_commits, ãƒªãƒ¢ãƒ¼ãƒˆ:$remote_commits)" >> health-report.md
        fi
        
    - name: Trigger Auto-Repair if Problems Detected
      if: env.HEALTH_STATUS == 'WARNING' || env.HEALTH_STATUS == 'CRITICAL'
      uses: actions/github-script@v7
      with:
        script: |
          console.log('ğŸ”§ å•é¡Œæ¤œå‡º - è‡ªå‹•ä¿®å¾©ã‚µã‚¤ã‚¯ãƒ«ã‚’ãƒˆãƒªã‚¬ãƒ¼');
          
          // è‡ªå‹•ä¿®å¾©ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'auto-repair-cycle.yml',
            ref: 'main',
            inputs: {
              repair_type: 'auto'
            }
          });
          
          console.log('âœ… è‡ªå‹•ä¿®å¾©ã‚µã‚¤ã‚¯ãƒ«é–‹å§‹ - ãƒ¡ãƒ¼ãƒ«é…ä¿¡ãªã—');
          
    - name: Upload Health Report
      uses: actions/upload-artifact@v4
      with:
        name: health-report-${{ github.run_number }}
        path: |
          health-report.md
          safety-quick.json
        retention-days: 7
        
    - name: Notification Summary
      run: |
        echo "=== ç¶™ç¶šçš„ç›£è¦–å®Œäº† ===" 
        echo "ğŸ• å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
        echo "ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: $HEALTH_STATUS"
        echo "ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆ: health-report-${{ github.run_number }}"
        echo "â° æ¬¡å›å®Ÿè¡Œ: 30åˆ†å¾Œ"