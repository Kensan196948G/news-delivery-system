name: Smart Commit Strategy

on:
  workflow_dispatch:
    inputs:
      commit_batch_size:
        description: 'バッチサイズ（ファイル数）'
        required: true
        default: '5'
        type: string
      delay_minutes:
        description: '待機時間（分）'
        required: true
        default: '2'
        type: string

permissions:
  contents: write

jobs:
  smart-batch-commit:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Smart Commit with Rate Limit Consideration
      run: |
        echo "=== 🤖 スマートコミット戦略 ===" 
        
        BATCH_SIZE="$\{\{{ github.event.inputs.commit_batch_size \}\}}"
        DELAY_MINUTES="$\{\{{ github.event.inputs.delay_minutes \}\}}"
        
        echo "📊 設定:"
        echo "- バッチサイズ: $\{\{BATCH_SIZE\}\}ファイル"
        echo "- 待機時間: $\{\{DELAY_MINUTES\}\}分"
        
        # 変更ファイルを取得
        changed_files=($(git status --porcelain | head -n 50 | awk '{print $2}'))
        total_files=$\{\{#changed_files[@]\}\}
        
        echo "📁 変更ファイル数: $total_files"
        
        if [ $total_files -eq 0 ]; then
          echo "✅ 変更なし - コミット不要"
          exit 0
        fi
        
        # Git設定
        git config --global user.name "Smart Commit Bot"
        git config --global user.email "smart-commit@news-delivery-system.local"
        
        # バッチ処理
        batch_count=0
        for ((i=0; i<total_files; i+=BATCH_SIZE)); do
          batch_count=$((batch_count + 1))
          
          echo "📦 バッチ $\{\{batch_count\}\} 処理中..."
          
          # 現在のバッチファイルを取得
          batch_files=("$\{\{changed_files[@]:i:BATCH_SIZE\}\}")
          
          if [ $\{\{#batch_files[@]\}\} -gt 0 ]; then
            # バッチファイルをステージング
            for file in "$\{\{batch_files[@]\}\}"; do
              if [ -f "$file" ]; then
                git add "$file"
                echo "  ✅ 追加: $file"
              fi
            done
            
            # バッチコミット
            git commit -m "feat: バッチ$\{\{batch_count\}\} - 機能追加・改善 | ファイル数: $\{\{#batch_files[@]\}\} | レート制限対策: スマートコミット戦略適用 | 🤖 Generated with Claude Code"
            echo "✅ バッチ $\{\{batch_count\}\} コミット完了"
            
            # CodeRabbit AI レート制限対策の待機
            if [ $((i + BATCH_SIZE)) -lt $total_files ]; then
              echo "⏰ $\{\{DELAY_MINUTES\}\}分待機中（レート制限対策）..."
              sleep $((DELAY_MINUTES * 60))
            fi
          fi
        done
        
        echo "🎉 全バッチ処理完了"
        echo "📊 総バッチ数: $batch_count"
        echo "📁 総ファイル数: $total_files"
        
        # 最終プッシュ
        git push origin HEAD
        echo "✅ プッシュ完了"