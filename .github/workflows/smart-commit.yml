name: Smart Commit Strategy

on:
  workflow_dispatch:
    inputs:
      commit_batch_size:
        description: 'ãƒãƒƒãƒã‚µã‚¤ã‚ºï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ•°ï¼‰'
        required: true
        default: '5'
        type: string
      delay_minutes:
        description: 'å¾…æ©Ÿæ™‚é–“ï¼ˆåˆ†ï¼‰'
        required: true
        default: '2'
        type: string

permissions:
  contents: write

jobs:
  smart-batch-commit:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Smart Commit with Rate Limit Consideration
      run: |
        echo "=== ğŸ¤– ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒŸãƒƒãƒˆæˆ¦ç•¥ ===" 
        
        BATCH_SIZE="$\{\{{ github.event.inputs.commit_batch_size \}\}}"
        DELAY_MINUTES="$\{\{{ github.event.inputs.delay_minutes \}\}}"
        
        echo "ğŸ“Š è¨­å®š:"
        echo "- ãƒãƒƒãƒã‚µã‚¤ã‚º: $\{\{BATCH_SIZE\}\}ãƒ•ã‚¡ã‚¤ãƒ«"
        echo "- å¾…æ©Ÿæ™‚é–“: $\{\{DELAY_MINUTES\}\}åˆ†"
        
        # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        changed_files=($(git status --porcelain | head -n 50 | awk '{print $2}'))
        total_files=$\{\{#changed_files[@]\}\}
        
        echo "ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $total_files"
        
        if [ $total_files -eq 0 ]; then
          echo "âœ… å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆä¸è¦"
          exit 0
        fi
        
        # Gitè¨­å®š
        git config --global user.name "Smart Commit Bot"
        git config --global user.email "smart-commit@news-delivery-system.local"
        
        # ãƒãƒƒãƒå‡¦ç†
        batch_count=0
        for ((i=0; i<total_files; i+=BATCH_SIZE)); do
          batch_count=$((batch_count + 1))
          
          echo "ğŸ“¦ ãƒãƒƒãƒ $\{\{batch_count\}\} å‡¦ç†ä¸­..."
          
          # ç¾åœ¨ã®ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          batch_files=("$\{\{changed_files[@]:i:BATCH_SIZE\}\}")
          
          if [ $\{\{#batch_files[@]\}\} -gt 0 ]; then
            # ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
            for file in "$\{\{batch_files[@]\}\}"; do
              if [ -f "$file" ]; then
                git add "$file"
                echo "  âœ… è¿½åŠ : $file"
              fi
            done
            
            # ãƒãƒƒãƒã‚³ãƒŸãƒƒãƒˆ
            git commit -m "feat: ãƒãƒƒãƒ$\{\{batch_count\}\} - æ©Ÿèƒ½è¿½åŠ ãƒ»æ”¹å–„ | ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $\{\{#batch_files[@]\}\} | ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–: ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒŸãƒƒãƒˆæˆ¦ç•¥é©ç”¨ | ğŸ¤– Generated with Claude Code"
            echo "âœ… ãƒãƒƒãƒ $\{\{batch_count\}\} ã‚³ãƒŸãƒƒãƒˆå®Œäº†"
            
            # CodeRabbit AI ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ã®å¾…æ©Ÿ
            if [ $((i + BATCH_SIZE)) -lt $total_files ]; then
              echo "â° $\{\{DELAY_MINUTES\}\}åˆ†å¾…æ©Ÿä¸­ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼‰..."
              sleep $((DELAY_MINUTES * 60))
            fi
          fi
        done
        
        echo "ğŸ‰ å…¨ãƒãƒƒãƒå‡¦ç†å®Œäº†"
        echo "ğŸ“Š ç·ãƒãƒƒãƒæ•°: $batch_count"
        echo "ğŸ“ ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $total_files"
        
        # æœ€çµ‚ãƒ—ãƒƒã‚·ãƒ¥
        git push origin HEAD
        echo "âœ… ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"