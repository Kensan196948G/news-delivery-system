name: ğŸ¤– Automated News System CI/CD

"on":
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]
  schedule:
    # ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆæ¯æ—¥æ·±å¤œ2æ™‚ï¼‰
    - cron: '0 2 * * *'
    # é€±æ¬¡ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆæ—¥æ›œæ—¥æ·±å¤œ1æ™‚ï¼‰
    - cron: '0 1 * * 0'
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Test Level'
        required: true
        type: choice
        options:
          - 'basic'
          - 'full'
          - 'stress'
        default: 'basic'
      auto_fix:
        description: 'Enable Auto-Fix'
        required: false
        type: boolean
        default: true
      deploy_target:
        description: 'Deployment Target'
        required: false
        type: choice
        options:
          - 'none'
          - 'staging'
          - 'production'
        default: 'none'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  CACHE_VERSION: 'v2'
  AUTO_FIX_ENABLED: ${{ github.event.inputs.auto_fix || 'true' }}
  TEST_LEVEL: ${{ github.event.inputs.test_level || 'basic' }}

permissions:
  contents: write
  actions: read
  checks: write
  pull-requests: write
  statuses: write
  security-events: write
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ========================================
  # 1. ç’°å¢ƒæº–å‚™ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–
  # ========================================
  setup:
    name: ğŸš€ Environment Setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      python-cache-key: ${{ steps.cache.outputs.python-cache-key }}
      node-cache-key: ${{ steps.cache.outputs.node-cache-key }}
      test-files-changed: ${{ steps.changes.outputs.tests }}
      src-files-changed: ${{ steps.changes.outputs.src }}
      docs-files-changed: ${{ steps.changes.outputs.docs }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ” Detect File Changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            tests:
              - 'tests/**'
              - 'pytest.ini'
              - 'conftest.py'
            src:
              - 'src/**'
              - '*.py'
            docs:
              - 'docs/**'
              - '*.md'
              - 'mkdocs.yml'
            workflows:
              - '.github/workflows/**'
      
      - name: ğŸ§® Generate Test Matrix
        id: matrix
        run: |
          if [[ "${{ steps.changes.outputs.src }}" == "true" ]] || [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo 'matrix={"os":["ubuntu-latest","windows-latest"],"python-version":["3.10","3.11","3.12"],"test-type":["unit","integration","performance"]}' >> $GITHUB_OUTPUT
          else
            echo 'matrix={"os":["ubuntu-latest"],"python-version":["3.11"],"test-type":["unit"]}' >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ—‚ï¸ Setup Cache Keys
        id: cache
        run: |
          echo "python-cache-key=${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}" >> $GITHUB_OUTPUT
          echo "node-cache-key=${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package*.json') }}" >> $GITHUB_OUTPUT

  # ========================================
  # 2. ä¸¦åˆ—ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆMatrix Strategyï¼‰
  # ========================================
  quality-gate:
    name: ğŸ” Quality Gate (${{ matrix.check-type }})
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        check-type:
          - 'syntax'      # æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          - 'style'       # ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«
          - 'security'    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
          - 'complexity'  # è¤‡é›‘åº¦
          - 'performance' # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: '**/requirements*.txt'
      
      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ needs.setup.outputs.python-cache-key }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-
      
      - name: ğŸ”§ Install Dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install flake8 black isort bandit pylint radon mypy pytest coverage safety vulture
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      
      - name: ğŸ” Run Quality Checks
        id: quality
        run: |
          case "${{ matrix.check-type }}" in
            "syntax")
              echo "::group::Syntax Check"
              python -m py_compile src/**/*.py || echo "compile_errors=true" >> $GITHUB_OUTPUT
              flake8 src/ tests/ --max-line-length=100 --extend-ignore=E203,W503 || echo "flake8_errors=true" >> $GITHUB_OUTPUT
              echo "::endgroup::"
              ;;
            "style")
              echo "::group::Code Style Check"
              black --check --diff src/ tests/ || echo "style_errors=true" >> $GITHUB_OUTPUT
              isort --check-only --diff src/ tests/ || echo "import_errors=true" >> $GITHUB_OUTPUT
              echo "::endgroup::"
              ;;
            "security")
              echo "::group::Security Scan"
              bandit -r src/ -f json -o bandit-report.json || echo "security_issues=true" >> $GITHUB_OUTPUT
              safety check --json || echo "dependency_vulnerabilities=true" >> $GITHUB_OUTPUT
              echo "::endgroup::"
              ;;
            "complexity")
              echo "::group::Complexity Analysis"
              radon cc src/ --min=B || echo "high_complexity=true" >> $GITHUB_OUTPUT
              radon mi src/ --min=B || echo "low_maintainability=true" >> $GITHUB_OUTPUT
              vulture src/ || echo "dead_code=true" >> $GITHUB_OUTPUT
              echo "::endgroup::"
              ;;
            "performance")
              echo "::group::Performance Analysis"
              pylint src/ --disable=all --enable=W0622,C0415 || echo "performance_issues=true" >> $GITHUB_OUTPUT
              echo "::endgroup::"
              ;;
          esac
      
      - name: ğŸ”§ Auto-Fix Issues
        if: env.AUTO_FIX_ENABLED == 'true' && steps.quality.outputs.style_errors == 'true'
        run: |
          echo "::group::Auto-fixing style issues"
          black src/ tests/
          isort src/ tests/
          echo "::endgroup::"
      
      - name: ğŸ“Š Upload Security Reports
        if: matrix.check-type == 'security'
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            bandit-report.json
          retention-days: 30

  # ========================================
  # 3. ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  # ========================================
  test-matrix:
    name: ğŸ§ª Tests (${{ matrix.os }}, Python ${{ matrix.python-version }}, ${{ matrix.test-type }})
    runs-on: ${{ matrix.os }}
    needs: [setup, quality-gate]
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: ğŸ”§ Install Dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-xdist pytest-benchmark coverage
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      
      - name: ğŸ§ª Run Tests
        shell: bash
        run: |
          case "${{ matrix.test-type }}" in
            "unit")
              python -m pytest tests/test_*.py -v --cov=src --cov-report=xml --cov-report=html
              ;;
            "integration")
              python -m pytest tests/integration/ -v --cov=src --cov-append
              ;;
            "performance")
              python -m pytest tests/test_optimizations.py -v --benchmark-only --benchmark-json=benchmark.json
              ;;
          esac
      
      - name: ğŸ“Š Upload Coverage Reports
        if: matrix.test-type == 'unit' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
      
      - name: ğŸ“ˆ Upload Performance Results
        if: matrix.test-type == 'performance'
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results-${{ matrix.os }}-${{ matrix.python-version }}
          path: benchmark.json

  # ========================================
  # 4. è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ã¨ä¿®å¾©
  # ========================================
  auto-repair:
    name: ğŸ”§ Auto-Repair System
    runs-on: ubuntu-latest
    needs: [test-matrix]
    if: failure() && github.event.inputs.auto_fix != 'false'
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ”§ Install Repair Tools
        run: |
          pip install autopep8 autoflake black isort add-trailing-comma
          pip install -r requirements.txt
      
      - name: ğŸ” Analyze Failures
        id: analyze
        run: |
          echo "::group::Analyzing test failures"
          
          # ä¸€èˆ¬çš„ãªä¿®å¾©ãƒ‘ã‚¿ãƒ¼ãƒ³
          FIXES_APPLIED=""
          
          # 1. Importé †åºã®ä¿®æ­£
          if isort --check-only src/ tests/ 2>/dev/null; then
            echo "Fixing import order..."
            isort src/ tests/
            FIXES_APPLIED="${FIXES_APPLIED}import-order,"
          fi
          
          # 2. ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ä¿®æ­£
          if ! black --check src/ tests/ 2>/dev/null; then
            echo "Fixing code format..."
            black src/ tests/
            FIXES_APPLIED="${FIXES_APPLIED}formatting,"
          fi
          
          # 3. æœªä½¿ç”¨importã®å‰Šé™¤
          echo "Removing unused imports..."
          autoflake --remove-all-unused-imports --recursive --in-place src/ tests/
          FIXES_APPLIED="${FIXES_APPLIED}unused-imports,"
          
          # 4. ãƒˆãƒ¬ãƒ¼ãƒªãƒ³ã‚°ã‚«ãƒ³ãƒã®è¿½åŠ 
          echo "Adding trailing commas..."
          add-trailing-comma --py36-plus src/**/*.py tests/**/*.py
          FIXES_APPLIED="${FIXES_APPLIED}trailing-commas,"
          
          echo "fixes_applied=${FIXES_APPLIED}" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: ğŸ§ª Re-run Tests
        id: retest
        run: |
          echo "::group::Re-running tests after fixes"
          if python -m pytest tests/ -x --tb=short; then
            echo "retest_passed=true" >> $GITHUB_OUTPUT
          else
            echo "retest_passed=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"
      
      - name: ğŸ’¾ Commit Auto-Fixes
        if: steps.analyze.outputs.fixes_applied != '' && steps.retest.outputs.retest_passed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git diff --staged --quiet || git commit -m "ğŸ¤– auto-fix: ${FIXES_APPLIED%,}

          Applied automatic fixes:
          $(echo "${{ steps.analyze.outputs.fixes_applied }}" | tr ',' '\n' | sed 's/^/- /')
          
          ğŸ¤– Generated with Claude Code
          Co-Authored-By: Claude <noreply@anthropic.com>"
      
      - name: ğŸš€ Push Auto-Fixes
        if: steps.analyze.outputs.fixes_applied != '' && steps.retest.outputs.retest_passed == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

  # ========================================
  # 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  # ========================================
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ›¡ï¸ Install Security Tools
        run: |
          pip install bandit safety semgrep pip-audit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: ğŸ” Run Security Scans
        run: |
          echo "::group::Bandit Security Scan"
          bandit -r src/ -f json -o bandit-results.json || true
          echo "::endgroup::"
          
          echo "::group::Safety Dependency Check"
          safety check --json --output safety-results.json || true
          echo "::endgroup::"
          
          echo "::group::Pip Audit"
          pip-audit --format=json --output=pip-audit-results.json || true
          echo "::endgroup::"
          
          echo "::group::Semgrep SAST"
          semgrep --config=auto src/ --json --output=semgrep-results.json || true
          echo "::endgroup::"
      
      - name: ğŸ“Š Upload Security Results
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-results
          path: |
            bandit-results.json
            safety-results.json
            pip-audit-results.json
            semgrep-results.json
          retention-days: 30
      
      - name: ğŸ“ˆ Upload to GitHub Security
        if: github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: semgrep-results.json
        continue-on-error: true

  # ========================================
  # 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  # ========================================
  performance-test:
    name: âš¡ Performance Analysis
    runs-on: ubuntu-latest
    needs: [setup, test-matrix]
    if: needs.setup.outputs.src-files-changed == 'true' || github.event_name == 'schedule'
    timeout-minutes: 25
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ”§ Install Performance Tools
        run: |
          pip install pytest-benchmark memory-profiler py-spy
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: âš¡ Run Performance Tests
        run: |
          echo "::group::Memory Usage Analysis"
          mprof run python -m pytest tests/test_optimizations.py::test_memory_usage -v
          mprof plot --output=memory-profile.png
          echo "::endgroup::"
          
          echo "::group::CPU Profiling"
          py-spy record -o cpu-profile.svg -- python -m pytest tests/test_optimizations.py::test_cpu_usage -v
          echo "::endgroup::"
          
          echo "::group::Benchmark Tests"
          python -m pytest tests/test_optimizations.py -v --benchmark-json=benchmark-results.json
          echo "::endgroup::"
      
      - name: ğŸ“Š Upload Performance Reports
        uses: actions/upload-artifact@v3
        with:
          name: performance-reports
          path: |
            memory-profile.png
            cpu-profile.svg
            benchmark-results.json
            mprofile_*.dat
          retention-days: 30
      
      - name: ğŸ“ˆ Performance Regression Check
        id: regression
        run: |
          # å‰å›ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœã¨æ¯”è¼ƒ
          if [ -f "benchmark-baseline.json" ]; then
            python scripts/compare_benchmarks.py benchmark-baseline.json benchmark-results.json
          else
            echo "No baseline found, creating new baseline"
            cp benchmark-results.json benchmark-baseline.json
          fi

  # ========================================
  # 7. è‡ªå‹•ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
  # ========================================
  docs-automation:
    name: ğŸ“š Documentation Automation
    runs-on: ubuntu-latest
    needs: [setup, quality-gate]
    if: needs.setup.outputs.src-files-changed == 'true' || needs.setup.outputs.docs-files-changed == 'true'
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“š Install Documentation Tools
        run: |
          pip install sphinx sphinx-autodoc-typehints sphinx-rtd-theme
          pip install pydoc-markdown mkdocs mkdocs-material
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: ğŸ“– Generate API Documentation
        run: |
          echo "::group::Generating API docs"
          sphinx-apidoc -o docs/api src/ --force --separate
          echo "::endgroup::"
          
          echo "::group::Building Sphinx docs"
          cd docs && make html
          echo "::endgroup::"
      
      - name: ğŸ“‹ Generate README Metrics
        run: |
          echo "::group::Updating README badges"
          # ãƒ†ã‚¹ãƒˆæˆåŠŸç‡ã®è¨ˆç®—
          TEST_RESULTS=$(find . -name "pytest-results.xml" -o -name "test-results.xml" | head -1)
          if [ -f "$TEST_RESULTS" ]; then
            # XMLã‹ã‚‰æˆåŠŸç‡ã‚’æŠ½å‡ºã—ã¦READMEã®ãƒãƒƒã‚¸ã‚’æ›´æ–°
            python scripts/update_readme_badges.py
          fi
          echo "::endgroup::"
      
      - name: ğŸ’¾ Commit Documentation Updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/ README.md
          git diff --staged --quiet || git commit -m "ğŸ“š docs: è‡ªå‹•ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

          - APIä»•æ§˜æ›¸ã®è‡ªå‹•ç”Ÿæˆ
          - READMEãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ›´æ–°
          - ãƒ†ã‚¹ãƒˆæˆåŠŸç‡ãƒãƒƒã‚¸ã®æ›´æ–°
          
          ğŸ¤– Generated with Claude Code
          Co-Authored-By: Claude <noreply@anthropic.com>"
      
      - name: ğŸš€ Push Documentation
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

  # ========================================
  # 8. é€šçŸ¥ã¨ãƒ¬ãƒãƒ¼ãƒˆ
  # ========================================
  notification:
    name: ğŸ“¢ Notification & Reporting
    runs-on: ubuntu-latest
    needs: [test-matrix, security-scan, performance-test, auto-repair]
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ“Š Collect Results
        id: results
        run: |
          # å„ã‚¸ãƒ§ãƒ–ã®çµæœã‚’é›†è¨ˆ
          TESTS_STATUS="${{ needs.test-matrix.result }}"
          SECURITY_STATUS="${{ needs.security-scan.result }}"
          PERFORMANCE_STATUS="${{ needs.performance-test.result }}"
          REPAIR_STATUS="${{ needs.auto-repair.result }}"
          
          echo "tests=${TESTS_STATUS}" >> $GITHUB_OUTPUT
          echo "security=${SECURITY_STATUS}" >> $GITHUB_OUTPUT
          echo "performance=${PERFORMANCE_STATUS}" >> $GITHUB_OUTPUT
          echo "repair=${REPAIR_STATUS}" >> $GITHUB_OUTPUT
          
          # å…¨ä½“çš„ãªæˆåŠŸ/å¤±æ•—åˆ¤å®š
          if [[ "$TESTS_STATUS" == "success" && "$SECURITY_STATUS" == "success" ]]; then
            echo "overall=success" >> $GITHUB_OUTPUT
          else
            echo "overall=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“ Generate Report
        run: |
          cat > workflow-report.md << EOF
          # ğŸ¤– CI/CD Pipeline Report
          
          **Workflow**: ${{ github.workflow }}
          **Trigger**: ${{ github.event_name }}
          **Branch**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}
          **Date**: $(date)
          
          ## ğŸ“Š Results Summary
          
          | Component | Status | Details |
          |-----------|--------|---------|
          | ğŸ§ª Tests | ${{ steps.results.outputs.tests }} | Matrix testing across multiple environments |
          | ğŸ›¡ï¸ Security | ${{ steps.results.outputs.security }} | SAST, dependency scanning, vulnerability checks |
          | âš¡ Performance | ${{ steps.results.outputs.performance }} | Benchmark tests and memory profiling |
          | ğŸ”§ Auto-Repair | ${{ steps.results.outputs.repair }} | Automated issue detection and fixing |
          
          ## ğŸ¯ Overall Status: ${{ steps.results.outputs.overall }}
          
          EOF
      
      - name: ğŸ’¬ Slack Notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ steps.results.outputs.overall }}
          channel: '#ci-cd'
          text: |
            ğŸ¤– *Automated News System CI/CD*
            
            *Branch:* ${{ github.ref_name }}
            *Trigger:* ${{ github.event_name }}
            *Tests:* ${{ steps.results.outputs.tests }}
            *Security:* ${{ steps.results.outputs.security }}
            *Performance:* ${{ steps.results.outputs.performance }}
            
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: ğŸ“§ Email Report
        if: steps.results.outputs.overall == 'failure' && github.ref == 'refs/heads/main'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_PASSWORD }}
          subject: "âŒ CI/CD Pipeline Failed - ${{ github.repository }}"
          body: |
            Pipeline failed for commit ${{ github.sha }} on branch ${{ github.ref_name }}.
            
            Please check the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}

  # ========================================
  # 9. è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
  # ========================================
  deploy:
    name: ğŸš€ Automated Deployment
    runs-on: ubuntu-latest
    needs: [test-matrix, security-scan, performance-test]
    if: |
      github.ref == 'refs/heads/main' && 
      needs.test-matrix.result == 'success' && 
      needs.security-scan.result == 'success' &&
      (github.event.inputs.deploy_target != 'none' || github.event_name == 'schedule')
    environment: 
      name: ${{ github.event.inputs.deploy_target || 'staging' }}
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ Build Package
        run: |
          pip install build wheel
          python -m build
      
      - name: ğŸ§ª Pre-deployment Tests
        run: |
          # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚ãƒ†ã‚¹ãƒˆ
          python -m pytest tests/integration/ -v
      
      - name: ğŸš€ Deploy to ${{ github.event.inputs.deploy_target || 'staging' }}
        run: |
          echo "::group::Deploying to ${{ github.event.inputs.deploy_target || 'staging' }}"
          # ã“ã“ã«å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
          echo "Deployment simulation completed"
          echo "::endgroup::"
      
      - name: âœ… Post-deployment Verification
        run: |
          echo "::group::Verifying deployment"
          # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®å‹•ä½œç¢ºèª
          python scripts/health_check.py
          echo "::endgroup::"
      
      - name: ğŸ·ï¸ Create Release Tag
        if: github.event.inputs.deploy_target == 'production'
        run: |
          VERSION=$(python -c "import src; print(src.__version__)" 2>/dev/null || echo "1.0.0")
          git tag -a "v${VERSION}" -m "ğŸš€ Production release v${VERSION}"
          git push origin "v${VERSION}"

  # ========================================
  # 10. é‹ç”¨ç›£è¦–ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  # ========================================
  monitoring:
    name: ğŸ“Š System Monitoring
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“Š Generate System Metrics
        run: |
          echo "::group::Collecting system metrics"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºçµ±è¨ˆ
          find src/ -name "*.py" -exec wc -l {} + | tail -1 > metrics/loc.txt
          
          # ãƒ†ã‚¹ãƒˆæˆåŠŸç‡è¨ˆç®—
          python scripts/calculate_test_success_rate.py
          
          # ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
          pip install safety
          safety check --json > metrics/vulnerabilities.json || true
          
          echo "::endgroup::"
      
      - name: ğŸ“ˆ Update Metrics Dashboard
        run: |
          # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®æ›´æ–°
          python scripts/update_metrics_dashboard.py
      
      - name: ğŸ’¾ Commit Metrics
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add metrics/
          git diff --staged --quiet || git commit -m "ğŸ“Š metrics: è‡ªå‹•ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°

          - ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
          - ãƒ†ã‚¹ãƒˆæˆåŠŸç‡ã®è¨˜éŒ²
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã®æ›´æ–°
          
          ğŸ¤– Generated with Claude Code
          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push