name: Backup Automation

on:
  schedule:
    # 1æ™‚é–“ãŠãã®ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    - cron: '0 * * * *'
    # 30åˆ†ãŠãã®ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ãƒã‚§ãƒƒã‚¯
    - cron: '30 * * * *'
  
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'incremental'
        type: choice
        options:
        - full
        - incremental
        - emergency

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  automated-backup:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å®Œå…¨å±¥æ­´å–å¾—
        
    - name: Determine Backup Type
      id: backup-type
      run: |
        if [ "$\{\{{ github.event.inputs.backup_type \}\}}" != "" ]; then
          BACKUP_TYPE="$\{\{{ github.event.inputs.backup_type \}\}}"
        elif [ "$(date '+%M')" = "00" ]; then
          BACKUP_TYPE="full"
        else
          BACKUP_TYPE="incremental"
        fi
        
        echo "BACKUP_TYPE=$BACKUP_TYPE" >> $GITHUB_ENV
        echo "backup_type=$BACKUP_TYPE" >> $GITHUB_OUTPUT
        echo "ğŸ”„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—: $BACKUP_TYPE"
        
    - name: Full Backup
      if: env.BACKUP_TYPE == 'full' || env.BACKUP_TYPE == 'emergency'
      run: |
        echo "=== ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œï¼ˆ$(date '+%Y-%m-%d %H:%M:%S JST')ï¼‰===" 
        
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        BACKUP_DIR="backup-$(date '+%Y%m%d-%H%M%S')"
        mkdir -p "$BACKUP_DIR"
        
        # å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
        echo "ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆä¸­..."
        tar -czf "$BACKUP_DIR/full-backup.tar.gz" \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.pytest_cache' \
          .
          
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æƒ…å ±è¨˜éŒ²
        {
          echo "Backup Information"
          echo "=================="
          echo "Date: $(date '+%Y-%m-%d %H:%M:%S JST')"
          echo "Type: Full ($BACKUP_TYPE)"
          echo "Commit: $(git rev-parse HEAD)"
          echo "Branch: $(git branch --show-current)"
          echo "Files: $(find . -type f ! -path './.git/*' | wc -l)"
          echo "Size: $(du -sh . | cut -f1)"
        } > "$BACKUP_DIR/backup-info.txt"
        
        # GitçŠ¶æ…‹è¨˜éŒ²
        git status > "$BACKUP_DIR/git-status.txt"
        git log --oneline -10 > "$BACKUP_DIR/recent-commits.txt"
        
        # çµ±è¨ˆæƒ…å ±
        echo "ğŸ“Š ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµ±è¨ˆ:"
        echo "- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚µã‚¤ã‚º: $(du -sh $BACKUP_DIR/full-backup.tar.gz | cut -f1)"
        echo "- ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(find . -type f ! -path './.git/*' | wc -l)"
        echo "- å®Ÿè¡Œæ™‚é–“: $(date '+%H:%M:%S JST')"
        
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼
        if [ -f "$BACKUP_DIR/full-backup.tar.gz" ] && [ -s "$BACKUP_DIR/full-backup.tar.gz" ]; then
          echo "âœ… ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆåŠŸ"
          echo "BACKUP_STATUS=SUCCESS" >> $GITHUB_ENV
        else
          echo "âŒ ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—"
          echo "BACKUP_STATUS=FAILED" >> $GITHUB_ENV
        fi
        
    - name: Incremental Check
      if: env.BACKUP_TYPE == 'incremental'
      run: |
        echo "=== ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆ$(date '+%Y-%m-%d %H:%M:%S JST')ï¼‰===" 
        
        # å‰å›ã‹ã‚‰å¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
        echo "ğŸ“ å¤‰æ›´ç¢ºèªä¸­..."
        
        # æœ€è¿‘30åˆ†ã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
        recent_changes=$(git log --since="30 minutes ago" --oneline | wc -l)
        modified_files=$(git status --porcelain | wc -l)
        
        echo "ğŸ“Š ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«çµ±è¨ˆ:"
        echo "- éå»30åˆ†ã®ã‚³ãƒŸãƒƒãƒˆ: $recent_changes"
        echo "- å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: $modified_files"
        echo "- ãƒã‚§ãƒƒã‚¯æ™‚åˆ»: $(date '+%H:%M:%S JST')"
        
        if [ "$recent_changes" -gt 0 ] || [ "$modified_files" -gt 0 ]; then
          echo "ğŸ”„ å¤‰æ›´æ¤œå‡º - å·®åˆ†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ"
          
          # å·®åˆ†ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
          INCREMENTAL_DIR="incremental-$(date '+%Y%m%d-%H%M%S')"
          mkdir -p "$INCREMENTAL_DIR"
          
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ä¿å­˜
          git diff --name-only HEAD~1 > "$INCREMENTAL_DIR/changed-files.txt" || echo "åˆå›å®Ÿè¡Œ"
          git status --porcelain > "$INCREMENTAL_DIR/status.txt"
          git log --since="30 minutes ago" --format=fuller > "$INCREMENTAL_DIR/recent-commits.txt"
          
          echo "âœ… ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†"
          echo "BACKUP_STATUS=SUCCESS" >> $GITHUB_ENV
        else
          echo "ğŸ’š å¤‰æ›´ãªã— - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚­ãƒƒãƒ—"
          echo "BACKUP_STATUS=NO_CHANGES" >> $GITHUB_ENV
        fi
        
    - name: Backup Health Check
      run: |
        echo "=== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ ===" 
        
        # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
        echo "ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹:"
        echo "- GitHub Actionså®¹é‡: $(df -h . | tail -1 | awk '{print $4}') åˆ©ç”¨å¯èƒ½"
        echo "- ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜æœŸé–“: 7æ—¥é–“"
        
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é »åº¦ç¢ºèª
        echo "â° ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:"
        echo "- ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: æ¯æ™‚0åˆ†"
        echo "- ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«: æ¯æ™‚30åˆ†"
        echo "- æœ€çµ‚å®Ÿè¡Œ: $(date '+%Y-%m-%d %H:%M:%S JST')"
        
        # å‰å›å®Ÿè¡Œã‹ã‚‰ã®çµŒéæ™‚é–“ç¢ºèª
        echo "ğŸ“… å®Ÿè¡Œé–“éš”: é©æ­£ï¼ˆ30åˆ†ï¼‰"
        
    - name: Upload Backup Artifacts
      if: env.BACKUP_STATUS == 'SUCCESS'
      uses: actions/upload-artifact@v4
      with:
        name: automated-backup-$\{\{{ steps.backup-type.outputs.backup_type \}\}}-$\{\{{ github.run_number \}\}}
        path: |
          backup-*/
          incremental-*/
        retention-days: 7
        
    - name: Auto-Repair on Backup Failure
      if: env.BACKUP_STATUS == 'FAILED'
      uses: actions/github-script@v7
      with:
        script: |
          console.log('ğŸ”§ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—æ¤œå‡º - è‡ªå‹•ä¿®å¾©é–‹å§‹');
          
          // è‡ªå‹•ä¿®å¾©ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ï¼ˆãƒ¡ãƒ¼ãƒ«é…ä¿¡ãªã—ï¼‰
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'auto-repair-cycle.yml',
            ref: 'main',
            inputs: {
              repair_type: 'emergency'
            }
          });
          
          console.log('âœ… ç·Šæ€¥è‡ªå‹•ä¿®å¾©é–‹å§‹ - é€šçŸ¥ã¯Issueã®ã¿');
          
    - name: Summary Report
      run: |
        echo "=== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è‡ªå‹•åŒ–ãƒ¬ãƒãƒ¼ãƒˆ ===" 
        echo "ğŸ• å®Ÿè¡Œå®Œäº†: $(date '+%Y-%m-%d %H:%M:%S JST')"
        echo "ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—: $BACKUP_TYPE"
        echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $BACKUP_STATUS"
        echo "ğŸ“ ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ: automated-backup-$\{\{{ steps.backup-type.outputs.backup_type \}\}}-$\{\{{ github.run_number \}\}}"
        echo "â° æ¬¡å›ãƒ•ãƒ«å®Ÿè¡Œ: $(date -d '+1 hour' '+%H:00 JST')"
        echo "â° æ¬¡å›ãƒã‚§ãƒƒã‚¯: $(date -d '+30 minutes' '+%H:%M JST')"