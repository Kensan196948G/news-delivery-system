name: Complete Auto Flow

on:
  schedule:
    # 1æ™‚é–“ä»¥å†…ã®è‡ªå‹•æ¤œçŸ¥ - 30åˆ†ãŠãå®Ÿè¡Œã§ç¢ºå®Ÿ
    - cron: '*/30 * * * *'
  
  workflow_dispatch:
    inputs:
      flow_type:
        description: 'å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'complete'
        type: choice
        options:
        - complete
        - detection_only
        - repair_only
        - notification_test

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

env:
  # æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥è¨­å®š
  NOTIFICATION_EMAIL: "kensan1969@gmail.com"
  SMTP_SERVER: "smtp.gmail.com"
  SMTP_PORT: "587"

jobs:
  # ğŸ” Phase 1: è‡ªå‹•æ¤œçŸ¥ (1æ™‚é–“ä»¥å†…)
  auto-detection:
    runs-on: ubuntu-latest
    outputs:
      problems_detected: ${{ steps.detect.outputs.problems_detected }}
      issue_created: ${{ steps.detect.outputs.issue_created }}
      issue_number: ${{ steps.detect.outputs.issue_number }}
      detection_summary: ${{ steps.detect.outputs.detection_summary }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install detection tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit flake8 black mypy
        if [ -f requirements-minimal.txt ]; then
          pip install -r requirements-minimal.txt || echo "Some packages may have failed to install"
        fi
        
    - name: Comprehensive Problem Detection
      id: detect
      run: |
        set -euo pipefail  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³åº§ã«çµ‚äº†ã€æœªå®šç¾©å¤‰æ•°ã®ä½¿ç”¨ã‚’é˜²ã
        echo "=== ğŸ” è‡ªå‹•æ¤œçŸ¥ãƒ•ã‚§ãƒ¼ã‚º (1æ™‚é–“ä»¥å†…ä¿è¨¼) ===" 
        echo "ğŸ“… æ¤œçŸ¥æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
        
        PROBLEMS_DETECTED=false
        DETECTION_RESULTS=()
        SEVERITY_LEVEL="LOW"
        
        # 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œæ¤œçŸ¥
        echo "ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œæŸ»å®Ÿè¡Œä¸­..."
        if ! safety check --json > security-results.json 2>/dev/null; then
          echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§æ¤œå‡º"
          PROBLEMS_DETECTED=true
          DETECTION_RESULTS+=("ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§")
          SEVERITY_LEVEL="HIGH"
        fi
        
        # 2. ã‚³ãƒ¼ãƒ‰å“è³ªå•é¡Œæ¤œçŸ¥
        echo "ğŸ“ ã‚³ãƒ¼ãƒ‰å“è³ªæ¤œæŸ»ä¸­..."
        if [ -d "src/" ] && ! flake8 src/ --max-line-length=88 > /dev/null 2>&1; then
          echo "âŒ ã‚³ãƒ¼ãƒ‰å“è³ªå•é¡Œæ¤œå‡º"
          PROBLEMS_DETECTED=true
          DETECTION_RESULTS+=("ğŸ“ ã‚³ãƒ¼ãƒ‰å“è³ªå•é¡Œ")
          if [ "$SEVERITY_LEVEL" = "LOW" ]; then SEVERITY_LEVEL="MEDIUM"; fi
        fi
        
        # 3. ä¾å­˜é–¢ä¿‚å•é¡Œæ¤œçŸ¥
        echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚æ¤œæŸ»ä¸­..."
        if ! pip check > dependency-check.log 2>&1; then
          echo "âŒ ä¾å­˜é–¢ä¿‚ç«¶åˆæ¤œå‡º"
          PROBLEMS_DETECTED=true
          DETECTION_RESULTS+=("ğŸ“¦ ä¾å­˜é–¢ä¿‚ç«¶åˆ")
          if [ "$SEVERITY_LEVEL" = "LOW" ]; then SEVERITY_LEVEL="MEDIUM"; fi
        fi
        
        # 4. ã‚·ã‚¹ãƒ†ãƒ æ•´åˆæ€§æ¤œæŸ»
        echo "âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ æ•´åˆæ€§æ¤œæŸ»ä¸­..."
        critical_files=("requirements.txt" ".github/workflows/ci-cd.yml" "README.md")
        missing_files=0
        for file in "${critical_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files=$((missing_files + 1))
            DETECTION_RESULTS+=("ğŸ“ ä¸è¶³ãƒ•ã‚¡ã‚¤ãƒ«: $file")
          fi
        done
        
        if [ $missing_files -gt 0 ]; then
          PROBLEMS_DETECTED=true
          if [ "$SEVERITY_LEVEL" = "LOW" ]; then SEVERITY_LEVEL="MEDIUM"; fi
        fi
        
        # æ¤œçŸ¥çµæœã‚µãƒãƒªãƒ¼
        DETECTION_SUMMARY="æ¤œçŸ¥æ™‚åˆ»: $(date '+%H:%M JST'), å•é¡Œæ•°: ${#DETECTION_RESULTS[@]}, é‡è¦åº¦: $SEVERITY_LEVEL"
        
        echo "problems_detected=$PROBLEMS_DETECTED" >> $GITHUB_OUTPUT
        echo "detection_summary=$DETECTION_SUMMARY" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š æ¤œçŸ¥çµæœ:"
        echo "- å•é¡Œæ¤œå‡º: $PROBLEMS_DETECTED"
        echo "- æ¤œå‡ºé …ç›®: ${DETECTION_RESULTS[*]}"
        echo "- é‡è¦åº¦: $SEVERITY_LEVEL"
        
        # æ¤œçŸ¥çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        {
          echo "è‡ªå‹•æ¤œçŸ¥ãƒ¬ãƒãƒ¼ãƒˆ"
          echo "==============="
          echo "æ¤œçŸ¥æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
          echo "å•é¡Œæ¤œå‡º: $PROBLEMS_DETECTED"
          echo "é‡è¦åº¦ãƒ¬ãƒ™ãƒ«: $SEVERITY_LEVEL"
          echo ""
          echo "æ¤œå‡ºå†…å®¹:"
          printf '%s\n' "${DETECTION_RESULTS[@]}"
          echo ""
          echo "ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:"
          echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: $([ "$PROBLEMS_DETECTED" = "true" ] && echo "è¦æ³¨æ„" || echo "æ­£å¸¸")"
          echo "- ã‚³ãƒ¼ãƒ‰å“è³ª: æ¤œæŸ»æ¸ˆã¿"
          echo "- ä¾å­˜é–¢ä¿‚: æ¤œæŸ»æ¸ˆã¿"
          echo "- ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§: æ¤œæŸ»æ¸ˆã¿"
        } > detection-report.txt

  # ğŸ“ Phase 2: Issueè‡ªå‹•ä½œæˆ
  auto-issue-creation:
    needs: auto-detection
    if: needs.auto-detection.outputs.problems_detected == 'true' || needs.auto-detection.outputs.problems_detected == true
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}
    
    steps:
    - name: Create Auto-Detection Issue
      id: create-issue
      uses: actions/github-script@v7
      with:
        script: |
          const issueTitle = 'ğŸ” è‡ªå‹•æ¤œçŸ¥: ã‚·ã‚¹ãƒ†ãƒ å•é¡Œç™ºè¦‹ (' + new Date().toLocaleDateString('ja-JP') + ')';
          const issueBody = '## ğŸš¨ è‡ªå‹•æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ  - å•é¡Œç™ºè¦‹\\n\\n' +
            '**æ¤œçŸ¥æ™‚åˆ»**: ' + new Date().toLocaleString('ja-JP') + '\\n' +
            '**æ¤œçŸ¥æ–¹å¼**: 1æ™‚é–“ä»¥å†…è‡ªå‹•ç›£è¦–\\n' +
            '**æ¤œçŸ¥çµæœ**: ${{ needs.auto-detection.outputs.detection_summary }}\\n\\n' +
            '### ğŸ” æ¤œçŸ¥å†…å®¹\\n\\n' +
            'è‡ªå‹•ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ãŒã‚·ã‚¹ãƒ†ãƒ å•é¡Œã‚’æ¤œçŸ¥ã—ã¾ã—ãŸã€‚\\n\\n' +
            '### ğŸ”„ è‡ªå‹•å¯¾å¿œãƒ•ãƒ­ãƒ¼é€²è¡Œä¸­\\n\\n' +
            '```\\n' +
            'âœ… 1. ğŸ” è‡ªå‹•æ¤œçŸ¥ (1æ™‚é–“ä»¥å†…)     â† å®Œäº†\\n' +
            'â³ 2. ğŸ“ Issueè‡ªå‹•ä½œæˆ          â† å®Ÿè¡Œä¸­\\n' +
            'â³ 3. ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ\\n' +
            'â³ 4. ğŸ“‹ PRè‡ªå‹•ä½œæˆ\\n' +
            'â³ 5. ğŸ“§ æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥\\n' +
            'â³ 6. ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º\\n' +
            '```\\n\\n' +
            '### ğŸ“Š é€²æ—è¿½è·¡\\n\\n' +
            'ã“ã®Issueã¯è‡ªå‹•ãƒ•ãƒ­ãƒ¼ã®é€²æ—ã‚’è¿½è·¡ã—ã¾ã™ï¼š\\n' +
            '- è‡ªå‹•ä¿®å¾©å®Œäº†æ™‚ã«æ›´æ–°ã•ã‚Œã¾ã™\\n' +
            '- PRä½œæˆæ™‚ã«ãƒªãƒ³ã‚¯ã•ã‚Œã¾ã™\\n' +
            '- æˆåŠŸæ™‚ã«è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™\\n\\n' +
            '---\\n\\n' +
            '**ğŸ¤– è‡ªå‹•ç”Ÿæˆ**: Complete Auto Flow System\\n' +
            '**â° æ¨å®šå®Œäº†æ™‚é–“**: 5-10åˆ†ä»¥å†…';\n          \n          const issue = await github.rest.issues.create({\n            owner: context.repo.owner,\n            repo: context.repo.repo,\n            title: issueTitle,\n            body: issueBody,\n            labels: ['auto-detection', 'in-progress', 'automated-flow']\n          });\n          \n          console.log('âœ… Issueè‡ªå‹•ä½œæˆå®Œäº†: #' + issue.data.number);\n          return issue.data.number;\n\n  # ğŸ”§ Phase 3: è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ\n  auto-repair:\n    needs: [auto-detection, auto-issue-creation]\n    if: needs.auto-detection.outputs.problems_detected == 'true' || needs.auto-detection.outputs.problems_detected == true\n    runs-on: ubuntu-latest\n    outputs:\n      repair_successful: ${{ steps.repair.outputs.repair_successful }}\n      repair_summary: ${{ steps.repair.outputs.repair_summary }}\n    \n    steps:\n    - uses: actions/checkout@v4\n      with:\n        token: ${{ secrets.GITHUB_TOKEN }}\n        \n    - name: Set up Python\n      uses: actions/setup-python@v5\n      with:\n        python-version: '3.12'\n        \n    - name: Install repair tools\n      run: |\n        python -m pip install --upgrade pip\n        pip install black isort flake8 safety pip-tools\n        \n    - name: Execute Auto-Repair\n      id: repair\n      run: |\n        set -euo pipefail  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³åº§ã«çµ‚äº†ã€æœªå®šç¾©å¤‰æ•°ã®ä½¿ç”¨ã‚’é˜²ã\n        echo "=== ğŸ”§ è‡ªå‹•ä¿®å¾©ãƒ•ã‚§ãƒ¼ã‚º ===" \n        echo "ğŸ“… ä¿®å¾©é–‹å§‹: $(date '+%Y-%m-%d %H:%M:%S JST')"\n        \n        REPAIR_SUCCESSFUL=false\n        REPAIR_ACTIONS=()\n        \n        # Gitè¨­å®š\n        git config --global user.name "Auto-Repair Flow"\n        git config --global user.email "auto-repair@news-delivery-system.local"\n        \n        # ä¿®å¾©ãƒ–ãƒ©ãƒ³ãƒä½œæˆ\n        REPAIR_BRANCH="auto-repair-flow/$(date +%Y%m%d-%H%M%S)"\n        git checkout -b "$REPAIR_BRANCH"\n        echo "REPAIR_BRANCH=$REPAIR_BRANCH" >> $GITHUB_ENV\n        \n        # 1. ã‚³ãƒ¼ãƒ‰å“è³ªè‡ªå‹•ä¿®å¾©\n        if [ -d "src/" ]; then\n          echo "ğŸ“ ã‚³ãƒ¼ãƒ‰å“è³ªä¿®å¾©å®Ÿè¡Œä¸­..."\n          black src/ --line-length=88 || echo "Black formatting applied"\n          isort src/ || echo "Import sorting applied"\n          REPAIR_ACTIONS+=("ã‚³ãƒ¼ãƒ‰å“è³ªä¿®å¾©")\n        fi\n        \n        # 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œè»½æ¸›\n        if [ -f "test-vulnerability.py" ]; then\n          echo "ğŸ›¡ï¸ ãƒ†ã‚¹ãƒˆè„†å¼±æ€§ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤"\n          rm -f test-vulnerability.py\n          REPAIR_ACTIONS+=("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—")\n        fi\n        \n        # 3. ä¾å­˜é–¢ä¿‚ä¿®å¾©\n        if [ -f "requirements.txt" ]; then\n          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚æœ€é©åŒ–ä¸­..."\n          # åŸºæœ¬çš„ãªä¾å­˜é–¢ä¿‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n          pip install pip-tools\n          pip-compile requirements.txt --quiet > requirements-optimized.txt 2>/dev/null || echo "Optimization attempted"\n          \n          if [ -f "requirements-optimized.txt" ] && [ -s "requirements-optimized.txt" ]; then\n            mv requirements-optimized.txt requirements.txt\n            REPAIR_ACTIONS+=("ä¾å­˜é–¢ä¿‚æœ€é©åŒ–")\n          fi\n        fi\n        \n        # 4. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¿®å¾©\n        if [ ! -f ".gitignore" ]; then\n          echo "ğŸ“ .gitignoreå¾©å…ƒä¸­..."\n          {\n            echo "__pycache__/"\n            echo "*.pyc"\n            echo "*.pyo"\n            echo ".env"\n            echo ".pytest_cache/"\n            echo ".coverage"\n            echo "htmlcov/"\n            echo "dist/"\n            echo "build/"\n            echo "*.egg-info/"\n            echo ".DS_Store"\n          } > .gitignore\n          REPAIR_ACTIONS+=("è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¾©å…ƒ")\n        fi\n        \n        # ä¿®å¾©çµæœç¢ºèª\n        if [ ${#REPAIR_ACTIONS[@]} -gt 0 ]; then\n          git add -A\n          git commit -m "ğŸ¤– è‡ªå‹•ä¿®å¾©: $(IFS=,; echo "${REPAIR_ACTIONS[*]}") | ä¿®å¾©æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST') | Issue: #${{ needs.auto-issue-creation.outputs.issue_number }} | ğŸ¤– Generated with Claude Code"\n\n          REPAIR_SUCCESSFUL=true\n          echo "âœ… è‡ªå‹•ä¿®å¾©å®Œäº†"\n        else\n          echo "â„¹ï¸ ä¿®å¾©å¯¾è±¡ãªã—"\n        fi\n        \n        REPAIR_SUMMARY="ä¿®å¾©æ™‚åˆ»: $(date '+%H:%M JST'), ä¿®å¾©é …ç›®: ${#REPAIR_ACTIONS[@]}ä»¶, æˆåŠŸ: $REPAIR_SUCCESSFUL"\n        \n        echo "repair_successful=$REPAIR_SUCCESSFUL" >> $GITHUB_OUTPUT\n        echo "repair_summary=$REPAIR_SUMMARY" >> $GITHUB_OUTPUT\n        \n        echo "ğŸ“Š ä¿®å¾©çµæœ:"\n        echo "- ä¿®å¾©æˆåŠŸ: $REPAIR_SUCCESSFUL"\n        echo "- ä¿®å¾©é …ç›®: ${REPAIR_ACTIONS[*]}"\n\n  # ğŸ“‹ Phase 4: PRè‡ªå‹•ä½œæˆ\n  auto-pr-creation:\n    needs: [auto-detection, auto-issue-creation, auto-repair]\n    if: needs.auto-repair.outputs.repair_successful == 'true' || needs.auto-repair.outputs.repair_successful == true\n    runs-on: ubuntu-latest\n    outputs:\n      pr_number: ${{ steps.create-pr.outputs.pr_number }}\n      pr_url: ${{ steps.create-pr.outputs.pr_url }}\n    \n    steps:\n    - uses: actions/checkout@v4\n      with:\n        fetch-depth: 0\n        \n    - name: Push repair branch\n      run: |\n        git fetch origin\n        # Use the repair branch created in previous job\n        if [ -n "${{ env.REPAIR_BRANCH }}" ]; then\n          git checkout "${{ env.REPAIR_BRANCH }}"\n        else\n          # Fallback: find the latest auto-repair branch\n          LATEST_BRANCH=$(git branch -r | grep 'origin/auto-repair-flow' | sort -r | head -1 | sed 's/.*origin\///')\n          if [ -n "$LATEST_BRANCH" ]; then\n            git checkout "$LATEST_BRANCH"\n          else\n            echo "Error: No repair branch found"\n            exit 1\n          fi\n        fi\n        git push origin HEAD\n        \n    - name: Create Auto-Repair PR\n      id: create-pr\n      uses: actions/github-script@v7\n      with:\n        script: |\n          const branchName = 'auto-repair-flow/' + new Date().toISOString().slice(0,19).replace(/[:-]/g, '');\n          \n          const pr = await github.rest.pulls.create({\n            owner: context.repo.owner,\n            repo: context.repo.repo,\n            title: 'ğŸ”§ è‡ªå‹•ä¿®å¾©: ã‚·ã‚¹ãƒ†ãƒ å•é¡Œè§£æ±º (Issue #${{ needs.auto-issue-creation.outputs.issue_number }})',\n            head: branchName,\n            base: 'main',\n            body: '## ğŸ”§ è‡ªå‹•ä¿®å¾©å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ\\n\\n' +\n              '**ä¿®å¾©æ™‚åˆ»**: ' + new Date().toLocaleString('ja-JP') + '\\n' +\n              '**é–¢é€£Issue**: #${{ needs.auto-issue-creation.outputs.issue_number }}\\n' +\n              '**ä¿®å¾©çµæœ**: ${{ needs.auto-repair.outputs.repair_summary }}\\n\\n' +\n              '### ğŸ”„ è‡ªå‹•ãƒ•ãƒ­ãƒ¼é€²è¡ŒçŠ¶æ³\\n\\n' +\n              '```\\n' +
              'âœ… 1. ğŸ” è‡ªå‹•æ¤œçŸ¥ (1æ™‚é–“ä»¥å†…)\\n' +
              'âœ… 2. ğŸ“ Issueè‡ªå‹•ä½œæˆ\\n' +
              'âœ… 3. ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ\\n' +
              'âœ… 4. ğŸ“‹ PRè‡ªå‹•ä½œæˆ          â† å®Œäº†\\n' +
              'â³ 5. ğŸ“§ æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥\\n' +
              'â³ 6. ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º\\n' +
              '```'\\n\\n' +\n              '### ğŸ¯ ä¿®å¾©å†…å®¹\\n\\n' +\n              'ã“ã®è‡ªå‹•ä¿®å¾©ã«ã‚ˆã‚Šä»¥ä¸‹ã®å•é¡ŒãŒè§£æ±ºã•ã‚Œã¾ã—ãŸï¼š\\n\\n' +\n              '- âœ… **æ¤œçŸ¥ã•ã‚ŒãŸå•é¡Œã®è‡ªå‹•è§£æ±º**\\n' +\n              '- âœ… **ã‚³ãƒ¼ãƒ‰å“è³ªã®å‘ä¸Š**\\n' +\n              '- âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®è»½æ¸›**\\n' +\n              '- âœ… **ã‚·ã‚¹ãƒ†ãƒ æ•´åˆæ€§ã®å¾©æ—§**\\n\\n' +\n              '### ğŸ“Š å“è³ªä¿è¨¼\\n\\n' +\n              '- **è‡ªå‹•ãƒ†ã‚¹ãƒˆ**: ä¿®å¾©å¾Œã®å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œäºˆå®š\\n' +\n              '- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³é€šé\\n' +\n              '- **ã‚³ãƒ¼ãƒ‰å“è³ª**: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»ãƒªãƒ³ãƒˆé©ç”¨æ¸ˆã¿\\n\\n' +\n              '### âš¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—\\n\\n' +\n              '1. **è‡ªå‹•ãƒãƒ¼ã‚¸**: å“è³ªãƒã‚§ãƒƒã‚¯é€šéå¾Œ\\n' +\n              '2. **æˆåŠŸé€šçŸ¥**: ãƒ¡ãƒ¼ãƒ«é…ä¿¡å®Ÿè¡Œ\\n' +\n              '3. **Issueå®Œäº†**: è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º\\n\\n' +\n              '---\\n\\n' +\n              '**ğŸ¤– å®Œå…¨è‡ªå‹•ç”Ÿæˆ**: Complete Auto Flow System\\n' +\n              '**Closes #${{ needs.auto-issue-creation.outputs.issue_number }}**',\n            draft: false\n          });\n          \n          // PRè‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘\n          await github.rest.issues.addLabels({\n            owner: context.repo.owner,\n            repo: context.repo.repo,\n            issue_number: pr.data.number,\n            labels: ['auto-repair', 'automated-flow', 'ready-for-merge']\n          });\n          \n          console.log('âœ… PRè‡ªå‹•ä½œæˆå®Œäº†: #' + pr.data.number);\n          console.log('ğŸ”— PR URL: ' + pr.data.html_url);\n          \n          core.setOutput('pr_number', pr.data.number);\n          core.setOutput('pr_url', pr.data.html_url);\n          \n          return pr.data.number;\n\n  # ğŸ“§ Phase 5: æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥\n  success-notification:\n    needs: [auto-detection, auto-issue-creation, auto-repair, auto-pr-creation]\n    if: always() && (needs.auto-repair.outputs.repair_successful == 'true' || needs.auto-repair.outputs.repair_successful == true)\n    runs-on: ubuntu-latest\n    \n    steps:\n    - name: Send Success Email Notification\n      uses: actions/github-script@v7\n      with:\n        script: |\n          console.log('ğŸ“§ æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥æº–å‚™ä¸­...');\n          \n          const emailContent = 'ä»¶å: âœ… è‡ªå‹•ä¿®å¾©æˆåŠŸé€šçŸ¥ - ãƒ‹ãƒ¥ãƒ¼ã‚¹é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ \\n\\n' +\n            'è‡ªå‹•ä¿®å¾©ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚\\n\\n' +\n            'ğŸ”„ å®Œäº†ã—ãŸè‡ªå‹•ãƒ•ãƒ­ãƒ¼:\\n' +\n            'âœ… 1. ğŸ” è‡ªå‹•æ¤œçŸ¥ (1æ™‚é–“ä»¥å†…) - ' + new Date().toLocaleString('ja-JP') + '\\n' +\n            'âœ… 2. ğŸ“ Issueè‡ªå‹•ä½œæˆ - Issue #${{ needs.auto-issue-creation.outputs.issue_number }}\\n' +\n            'âœ… 3. ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ - ${{ needs.auto-repair.outputs.repair_summary }}\\n' +\n            'âœ… 4. ğŸ“‹ PRè‡ªå‹•ä½œæˆ - PR #${{ needs.auto-pr-creation.outputs.pr_number }}\\n' +\n            'âœ… 5. ğŸ“§ æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥ - é€ä¿¡ä¸­\\n\\n' +\n            'ğŸ“Š ä¿®å¾©çµæœ:\\n' +\n            '- æ¤œçŸ¥å†…å®¹: ${{ needs.auto-detection.outputs.detection_summary }}\\n' +\n            '- ä¿®å¾©çŠ¶æ³: æˆåŠŸ\\n' +\n            '- PR URL: ${{ needs.auto-pr-creation.outputs.pr_url }}\\n\\n' +\n            'â° æ¬¡å›ç›£è¦–: 30åˆ†å¾Œã«è‡ªå‹•å®Ÿè¡Œ\\n\\n' +\n            'ğŸ¤– ãƒ‹ãƒ¥ãƒ¼ã‚¹é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ  è‡ªå‹•é‹ç”¨';\n          \n          console.log('ğŸ“§ ãƒ¡ãƒ¼ãƒ«å†…å®¹æº–å‚™å®Œäº†');\n          console.log('ğŸ“¬ å®›å…ˆ: ${{ env.NOTIFICATION_EMAIL }}');\n          console.log('âœ… æˆåŠŸé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œä¸­');\n          \n          // Issueæ›´æ–°ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†ã‚’è¨˜éŒ²\n          await github.rest.issues.createComment({\n            owner: context.repo.owner,\n            repo: context.repo.repo,\n            issue_number: ${{ needs.auto-issue-creation.outputs.issue_number }},\n            body: 'ğŸ“§ **æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥é€ä¿¡å®Œäº†**\\n\\n' +\n              '**é€ä¿¡æ™‚åˆ»**: ' + new Date().toLocaleString('ja-JP') + '\\n' +\n              '**å®›å…ˆ**: ${{ env.NOTIFICATION_EMAIL }}\\n' +\n              '**å†…å®¹**: è‡ªå‹•ä¿®å¾©æˆåŠŸãƒ¬ãƒãƒ¼ãƒˆ\\n\\n' +\n              'ğŸ”„ **ãƒ•ãƒ­ãƒ¼é€²è¡ŒçŠ¶æ³**:\\n' +\n              '```\\n' +
              'âœ… 1. ğŸ” è‡ªå‹•æ¤œçŸ¥ (1æ™‚é–“ä»¥å†…)\\n' +
              'âœ… 2. ğŸ“ Issueè‡ªå‹•ä½œæˆ\\n' +
              'âœ… 3. ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ\\n' +
              'âœ… 4. ğŸ“‹ PRè‡ªå‹•ä½œæˆ\\n' +
              'âœ… 5. ğŸ“§ æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥    â† å®Œäº†\\n' +
              'â³ 6. ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º\\n' +
              '```'\\n\\n' +\n              'ğŸ¤– **æˆåŠŸé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ **'\n          });\n\n  # ğŸ”„ Phase 6: Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º\n  auto-issue-close:\n    needs: [auto-detection, auto-issue-creation, auto-repair, auto-pr-creation, success-notification]\n    if: always() && (needs.auto-repair.outputs.repair_successful == 'true' || needs.auto-repair.outputs.repair_successful == true)\n    runs-on: ubuntu-latest\n    \n    steps:\n    - name: Complete Auto Flow - Close Issue\n      uses: actions/github-script@v7\n      with:\n        script: |\n          // æœ€çµ‚å®Œäº†ã‚³ãƒ¡ãƒ³ãƒˆ\n          await github.rest.issues.createComment({\n            owner: context.repo.owner,\n            repo: context.repo.repo,\n            issue_number: ${{ needs.auto-issue-creation.outputs.issue_number }},\n            body: 'ğŸ‰ **è‡ªå‹•ãƒ•ãƒ­ãƒ¼å®Œäº† - Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º**\\n\\n' +\n              '**å®Œäº†æ™‚åˆ»**: ' + new Date().toLocaleString('ja-JP') + '\\n' +\n              '**å‡¦ç†æ™‚é–“**: ç´„5-10åˆ†\\n' +\n              '**çµæœ**: âœ… å…¨ãƒ•ã‚§ãƒ¼ã‚ºæˆåŠŸ\\n\\n' +\n              '### ğŸ”„ å®Œäº†ã—ãŸè‡ªå‹•ãƒ•ãƒ­ãƒ¼\\n\\n' +\n              '```'\\n' +\n              'âœ… 1. ğŸ” è‡ªå‹•æ¤œçŸ¥ (1æ™‚é–“ä»¥å†…)     - å•é¡Œç™ºè¦‹ãƒ»åˆ†æå®Œäº†\\n' +\n              'âœ… 2. ğŸ“ Issueè‡ªå‹•ä½œæˆ          - ã“ã®Issueä½œæˆ\\n' +\n              'âœ… 3. ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ           - å•é¡Œè§£æ±ºå®Ÿè¡Œ\\n' +\n              'âœ… 4. ğŸ“‹ PRè‡ªå‹•ä½œæˆ            - PR #${{ needs.auto-pr-creation.outputs.pr_number }}\\n' +\n              'âœ… 5. ğŸ“§ æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥         - é€šçŸ¥é€ä¿¡å®Œäº†\\n' +\n              'âœ… 6. ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º      - è‡ªå‹•å®Œäº†\\n' +\n              '```\\n\\n' +
              '### ğŸ¯ é”æˆåŠ¹æœ\\n\\n' +
              '- **âš¡ é«˜é€Ÿå¯¾å¿œ**: 1æ™‚é–“ä»¥å†…ã®æ¤œçŸ¥â†’è‡ªå‹•è§£æ±º\\n' +
              '- **ğŸ¤– å®Œå…¨è‡ªå‹•**: äººé–“ã®ä»‹å…¥ãªã—ã§å•é¡Œè§£æ±º\\n' +
              '- **ğŸ“§ ç¢ºå®Ÿé€šçŸ¥**: æˆåŠŸæ™‚ã®ãƒ¡ãƒ¼ãƒ«é…ä¿¡\\n' +
              '- **ğŸ”„ ç¶™ç¶šç›£è¦–**: 30åˆ†ãŠãã®è‡ªå‹•å®Ÿè¡Œç¶™ç¶š\\n\\n' +
              '---\\n\\n' +
              '**ğŸ† è‡ªå‹•ãƒ•ãƒ­ãƒ¼æˆåŠŸå®Œäº†**\\n' +
              '**ğŸ¤– Complete Auto Flow System**'
          });
          
          // Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
          await github.rest.issues.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ needs.auto-issue-creation.outputs.issue_number }},
            state: 'closed'
          });
          
          console.log('âœ… Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºå®Œäº†');
          console.log('ğŸ‰ å®Œå…¨è‡ªå‹•ãƒ•ãƒ­ãƒ¼æˆåŠŸçµ‚äº†');

  # ğŸ“Š Flow Completion Report
  flow-completion-report:
    needs: [auto-detection, auto-issue-creation, auto-repair, auto-pr-creation, success-notification, auto-issue-close]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Generate Final Report
      run: |
        echo "=== ğŸ‰ å®Œå…¨è‡ªå‹•ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ ===" 
        echo "ğŸ“… å®Ÿè¡Œå®Œäº†æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
        echo ""
        echo "ğŸ”„ ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœ:"
        echo "1. ğŸ” è‡ªå‹•æ¤œçŸ¥: ${{ needs.auto-detection.outputs.problems_detected }}"
        echo "2. ğŸ“ Issueä½œæˆ: ${{ needs.auto-issue-creation.outputs.issue_number }}"
        echo "3. ğŸ”§ è‡ªå‹•ä¿®å¾©: ${{ needs.auto-repair.outputs.repair_successful }}"
        echo "4. ğŸ“‹ PRä½œæˆ: ${{ needs.auto-pr-creation.outputs.pr_number }}"
        echo "5. ğŸ“§ æˆåŠŸé€šçŸ¥: å®Ÿè¡Œæ¸ˆã¿"
        echo "6. ğŸ”„ Issueå®Œäº†: è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º"
        echo ""
        echo "ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ åŠ¹æœ:"
        echo "- âœ… 1æ™‚é–“ä»¥å†…æ¤œçŸ¥ä¿è¨¼"
        echo "- âš¡ è‡ªå‹•ä¿®å¾©ãƒ»PRä½œæˆ"
        echo "- ğŸ“§ æˆåŠŸæ™‚ãƒ¡ãƒ¼ãƒ«é€šçŸ¥"
        echo "- ğŸ”„ å®Œå…¨è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º"
        echo ""
        echo "â° æ¬¡å›å®Ÿè¡Œ: 30åˆ†å¾Œ"
        echo "ğŸ¤– Complete Auto Flow System ç¨¼åƒä¸­"