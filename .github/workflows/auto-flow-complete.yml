name: Complete Auto Flow

on:
  schedule:
    # 1æ™‚é–“ä»¥å†…ã®è‡ªå‹•æ¤œçŸ¥ - 30åˆ†ãŠãå®Ÿè¡Œã§ç¢ºå®Ÿ
    - cron: '*/30 * * * *'
  
  workflow_dispatch:
    inputs:
      flow_type:
        description: 'å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'complete'
        type: choice
        options:
        - complete
        - detection_only
        - repair_only
        - notification_test

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

env:
  # æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥è¨­å®š
  NOTIFICATION_EMAIL: "kensan1969@gmail.com"
  SMTP_SERVER: "smtp.gmail.com"
  SMTP_PORT: "587"

jobs:
  # ğŸ” Phase 1: è‡ªå‹•æ¤œçŸ¥ (1æ™‚é–“ä»¥å†…)
  auto-detection:
    runs-on: ubuntu-latest
    outputs:
      problems_detected: ${{ steps.detect.outputs.problems_detected }}
      issue_created: ${{ steps.detect.outputs.issue_created }}
      issue_number: ${{ steps.detect.outputs.issue_number }}
      detection_summary: ${{ steps.detect.outputs.detection_summary }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install detection tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit flake8 black mypy
        pip install -r requirements-minimal.txt || echo "Requirements installation check"
        
    - name: Comprehensive Problem Detection
      id: detect
      run: |
        echo "=== ğŸ” è‡ªå‹•æ¤œçŸ¥ãƒ•ã‚§ãƒ¼ã‚º (1æ™‚é–“ä»¥å†…ä¿è¨¼) ===" 
        echo "ğŸ“… æ¤œçŸ¥æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
        
        PROBLEMS_DETECTED=false
        DETECTION_RESULTS=()
        SEVERITY_LEVEL="LOW"
        
        # 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œæ¤œçŸ¥
        echo "ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œæŸ»å®Ÿè¡Œä¸­..."
        if ! safety check --json > security-results.json 2>/dev/null; then
          echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§æ¤œå‡º"
          PROBLEMS_DETECTED=true
          DETECTION_RESULTS+=("ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§")
          SEVERITY_LEVEL="HIGH"
        fi
        
        # 2. ã‚³ãƒ¼ãƒ‰å“è³ªå•é¡Œæ¤œçŸ¥
        echo "ğŸ“ ã‚³ãƒ¼ãƒ‰å“è³ªæ¤œæŸ»ä¸­..."
        if [ -d "src/" ] && ! flake8 src/ --max-line-length=88 > /dev/null 2>&1; then
          echo "âŒ ã‚³ãƒ¼ãƒ‰å“è³ªå•é¡Œæ¤œå‡º"
          PROBLEMS_DETECTED=true
          DETECTION_RESULTS+=("ğŸ“ ã‚³ãƒ¼ãƒ‰å“è³ªå•é¡Œ")
          if [ "$SEVERITY_LEVEL" = "LOW" ]; then SEVERITY_LEVEL="MEDIUM"; fi
        fi
        
        # 3. ä¾å­˜é–¢ä¿‚å•é¡Œæ¤œçŸ¥
        echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚æ¤œæŸ»ä¸­..."
        if ! pip check > dependency-check.log 2>&1; then
          echo "âŒ ä¾å­˜é–¢ä¿‚ç«¶åˆæ¤œå‡º"
          PROBLEMS_DETECTED=true
          DETECTION_RESULTS+=("ğŸ“¦ ä¾å­˜é–¢ä¿‚ç«¶åˆ")
          if [ "$SEVERITY_LEVEL" = "LOW" ]; then SEVERITY_LEVEL="MEDIUM"; fi
        fi
        
        # 4. ã‚·ã‚¹ãƒ†ãƒ æ•´åˆæ€§æ¤œæŸ»
        echo "âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ æ•´åˆæ€§æ¤œæŸ»ä¸­..."
        critical_files=("requirements.txt" ".github/workflows/ci-cd.yml" "README.md")
        missing_files=0
        for file in "${critical_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files=$((missing_files + 1))
            DETECTION_RESULTS+=("ğŸ“ ä¸è¶³ãƒ•ã‚¡ã‚¤ãƒ«: $file")
          fi
        done
        
        if [ $missing_files -gt 0 ]; then
          PROBLEMS_DETECTED=true
          if [ "$SEVERITY_LEVEL" = "LOW" ]; then SEVERITY_LEVEL="MEDIUM"; fi
        fi
        
        # æ¤œçŸ¥çµæœã‚µãƒãƒªãƒ¼
        DETECTION_SUMMARY="æ¤œçŸ¥æ™‚åˆ»: $(date '+%H:%M JST'), å•é¡Œæ•°: ${#DETECTION_RESULTS[@]}, é‡è¦åº¦: $SEVERITY_LEVEL"
        
        echo "problems_detected=$PROBLEMS_DETECTED" >> $GITHUB_OUTPUT
        echo "detection_summary=$DETECTION_SUMMARY" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š æ¤œçŸ¥çµæœ:"
        echo "- å•é¡Œæ¤œå‡º: $PROBLEMS_DETECTED"
        echo "- æ¤œå‡ºé …ç›®: ${DETECTION_RESULTS[*]}"
        echo "- é‡è¦åº¦: $SEVERITY_LEVEL"
        
        # æ¤œçŸ¥çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        {
          echo "è‡ªå‹•æ¤œçŸ¥ãƒ¬ãƒãƒ¼ãƒˆ"
          echo "==============="
          echo "æ¤œçŸ¥æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
          echo "å•é¡Œæ¤œå‡º: $PROBLEMS_DETECTED"
          echo "é‡è¦åº¦ãƒ¬ãƒ™ãƒ«: $SEVERITY_LEVEL"
          echo ""
          echo "æ¤œå‡ºå†…å®¹:"
          printf '%s\n' "${DETECTION_RESULTS[@]}"
          echo ""
          echo "ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:"
          echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: $([ "$PROBLEMS_DETECTED" = "true" ] && echo "è¦æ³¨æ„" || echo "æ­£å¸¸")"
          echo "- ã‚³ãƒ¼ãƒ‰å“è³ª: æ¤œæŸ»æ¸ˆã¿"
          echo "- ä¾å­˜é–¢ä¿‚: æ¤œæŸ»æ¸ˆã¿"
          echo "- ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§: æ¤œæŸ»æ¸ˆã¿"
        } > detection-report.txt

  # ğŸ“ Phase 2: Issueè‡ªå‹•ä½œæˆ
  auto-issue-creation:
    needs: auto-detection
    if: needs.auto-detection.outputs.problems_detected == 'true'
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}
    
    steps:
    - name: Create Auto-Detection Issue
      id: create-issue
      uses: actions/github-script@v7
      with:
        script: |
          const issueTitle = `ğŸ” è‡ªå‹•æ¤œçŸ¥: ã‚·ã‚¹ãƒ†ãƒ å•é¡Œç™ºè¦‹ (${new Date().toLocaleDateString('ja-JP')})`;
          const issueBody = `
## ğŸš¨ è‡ªå‹•æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ  - å•é¡Œç™ºè¦‹

**æ¤œçŸ¥æ™‚åˆ»**: ${new Date().toLocaleString('ja-JP')}
**æ¤œçŸ¥æ–¹å¼**: 1æ™‚é–“ä»¥å†…è‡ªå‹•ç›£è¦–
**æ¤œçŸ¥çµæœ**: ${{ needs.auto-detection.outputs.detection_summary }}

### ğŸ” æ¤œçŸ¥å†…å®¹

è‡ªå‹•ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ãŒã‚·ã‚¹ãƒ†ãƒ å•é¡Œã‚’æ¤œçŸ¥ã—ã¾ã—ãŸã€‚

### ğŸ”„ è‡ªå‹•å¯¾å¿œãƒ•ãƒ­ãƒ¼é€²è¡Œä¸­

\`\`\`
âœ… 1. ğŸ” è‡ªå‹•æ¤œçŸ¥ (1æ™‚é–“ä»¥å†…)     â† å®Œäº†
â³ 2. ğŸ“ Issueè‡ªå‹•ä½œæˆ          â† å®Ÿè¡Œä¸­  
â³ 3. ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ
â³ 4. ğŸ“‹ PRè‡ªå‹•ä½œæˆ
â³ 5. ğŸ“§ æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥
â³ 6. ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
\`\`\`

### ğŸ“Š é€²æ—è¿½è·¡

ã“ã®Issueã¯è‡ªå‹•ãƒ•ãƒ­ãƒ¼ã®é€²æ—ã‚’è¿½è·¡ã—ã¾ã™ï¼š
- è‡ªå‹•ä¿®å¾©å®Œäº†æ™‚ã«æ›´æ–°ã•ã‚Œã¾ã™
- PRä½œæˆæ™‚ã«ãƒªãƒ³ã‚¯ã•ã‚Œã¾ã™  
- æˆåŠŸæ™‚ã«è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™

---

**ğŸ¤– è‡ªå‹•ç”Ÿæˆ**: Complete Auto Flow System
**â° æ¨å®šå®Œäº†æ™‚é–“**: 5-10åˆ†ä»¥å†…
          `;
          
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['auto-detection', 'in-progress', 'automated-flow']
          });
          
          console.log(`âœ… Issueè‡ªå‹•ä½œæˆå®Œäº†: #${issue.data.number}`);
          return issue.data.number;

  # ğŸ”§ Phase 3: è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ
  auto-repair:
    needs: [auto-detection, auto-issue-creation]
    if: needs.auto-detection.outputs.problems_detected == 'true'
    runs-on: ubuntu-latest
    outputs:
      repair_successful: ${{ steps.repair.outputs.repair_successful }}
      repair_summary: ${{ steps.repair.outputs.repair_summary }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install repair tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 safety pip-tools
        
    - name: Execute Auto-Repair
      id: repair
      run: |
        echo "=== ğŸ”§ è‡ªå‹•ä¿®å¾©ãƒ•ã‚§ãƒ¼ã‚º ===" 
        echo "ğŸ“… ä¿®å¾©é–‹å§‹: $(date '+%Y-%m-%d %H:%M:%S JST')"
        
        REPAIR_SUCCESSFUL=false
        REPAIR_ACTIONS=()
        
        # Gitè¨­å®š
        git config --global user.name "Auto-Repair Flow"
        git config --global user.email "auto-repair@news-delivery-system.local"
        
        # ä¿®å¾©ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
        REPAIR_BRANCH="auto-repair-flow/$(date +%Y%m%d-%H%M%S)"
        git checkout -b "$REPAIR_BRANCH"
        echo "REPAIR_BRANCH=$REPAIR_BRANCH" >> $GITHUB_ENV
        
        # 1. ã‚³ãƒ¼ãƒ‰å“è³ªè‡ªå‹•ä¿®å¾©
        if [ -d "src/" ]; then
          echo "ğŸ“ ã‚³ãƒ¼ãƒ‰å“è³ªä¿®å¾©å®Ÿè¡Œä¸­..."
          black src/ --line-length=88 || echo "Black formatting applied"
          isort src/ || echo "Import sorting applied"
          REPAIR_ACTIONS+=("ã‚³ãƒ¼ãƒ‰å“è³ªä¿®å¾©")
        fi
        
        # 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œè»½æ¸›
        if [ -f "test-vulnerability.py" ]; then
          echo "ğŸ›¡ï¸ ãƒ†ã‚¹ãƒˆè„†å¼±æ€§ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤"
          rm -f test-vulnerability.py
          REPAIR_ACTIONS+=("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—")
        fi
        
        # 3. ä¾å­˜é–¢ä¿‚ä¿®å¾©
        if [ -f "requirements.txt" ]; then
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚æœ€é©åŒ–ä¸­..."
          # åŸºæœ¬çš„ãªä¾å­˜é–¢ä¿‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          pip install pip-tools
          pip-compile requirements.txt --quiet > requirements-optimized.txt 2>/dev/null || echo "Optimization attempted"
          
          if [ -f "requirements-optimized.txt" ] && [ -s "requirements-optimized.txt" ]; then
            mv requirements-optimized.txt requirements.txt
            REPAIR_ACTIONS+=("ä¾å­˜é–¢ä¿‚æœ€é©åŒ–")
          fi
        fi
        
        # 4. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¿®å¾©
        if [ ! -f ".gitignore" ]; then
          echo "ğŸ“ .gitignoreå¾©å…ƒä¸­..."
          cat > temp_file.txt << 'HEREDOC_END'
__pycache__/
*.pyc
*.pyo
.env
.pytest_cache/
.coverage
htmlcov/
dist/
build/
*.egg-info/
.DS_Store
HEREDOC_END
          REPAIR_ACTIONS+=("è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¾©å…ƒ")
        fi
        
        # ä¿®å¾©çµæœç¢ºèª
        if [ ${#REPAIR_ACTIONS[@]} -gt 0 ]; then
          git add -A
          git commit -m "ğŸ¤– è‡ªå‹•ä¿®å¾©: $(IFS=,; echo "${REPAIR_ACTIONS[*]}")

è‡ªå‹•æ¤œçŸ¥â†’ä¿®å¾©ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚‹å•é¡Œè§£æ±º:
$(printf '- %s\n' "${REPAIR_ACTIONS[@]}")

ä¿®å¾©æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')
Issue: #${{ needs.auto-issue-creation.outputs.issue_number }}

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)"

          REPAIR_SUCCESSFUL=true
          echo "âœ… è‡ªå‹•ä¿®å¾©å®Œäº†"
        else
          echo "â„¹ï¸ ä¿®å¾©å¯¾è±¡ãªã—"
        fi
        
        REPAIR_SUMMARY="ä¿®å¾©æ™‚åˆ»: $(date '+%H:%M JST'), ä¿®å¾©é …ç›®: ${#REPAIR_ACTIONS[@]}ä»¶, æˆåŠŸ: $REPAIR_SUCCESSFUL"
        
        echo "repair_successful=$REPAIR_SUCCESSFUL" >> $GITHUB_OUTPUT
        echo "repair_summary=$REPAIR_SUMMARY" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š ä¿®å¾©çµæœ:"
        echo "- ä¿®å¾©æˆåŠŸ: $REPAIR_SUCCESSFUL"
        echo "- ä¿®å¾©é …ç›®: ${REPAIR_ACTIONS[*]}"

  # ğŸ“‹ Phase 4: PRè‡ªå‹•ä½œæˆ
  auto-pr-creation:
    needs: [auto-detection, auto-issue-creation, auto-repair]
    if: needs.auto-repair.outputs.repair_successful == 'true'
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      pr_url: ${{ steps.create-pr.outputs.pr_url }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Push repair branch
      run: |
        git fetch origin
        git checkout auto-repair-flow/*
        git push origin HEAD
        
    - name: Create Auto-Repair PR
      id: create-pr
      uses: actions/github-script@v7
      with:
        script: |
          const branchName = `auto-repair-flow/${new Date().toISOString().slice(0,19).replace(/[:-]/g, '')}`;
          
          const pr = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ”§ è‡ªå‹•ä¿®å¾©: ã‚·ã‚¹ãƒ†ãƒ å•é¡Œè§£æ±º (Issue #${{ needs.auto-issue-creation.outputs.issue_number }})`,
            head: branchName,
            base: 'main',
            body: `
## ğŸ”§ è‡ªå‹•ä¿®å¾©å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ

**ä¿®å¾©æ™‚åˆ»**: ${new Date().toLocaleString('ja-JP')}
**é–¢é€£Issue**: #${{ needs.auto-issue-creation.outputs.issue_number }}
**ä¿®å¾©çµæœ**: ${{ needs.auto-repair.outputs.repair_summary }}

### ğŸ”„ è‡ªå‹•ãƒ•ãƒ­ãƒ¼é€²è¡ŒçŠ¶æ³

\`\`\`
âœ… 1. ğŸ” è‡ªå‹•æ¤œçŸ¥ (1æ™‚é–“ä»¥å†…)
âœ… 2. ğŸ“ Issueè‡ªå‹•ä½œæˆ
âœ… 3. ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ
âœ… 4. ğŸ“‹ PRè‡ªå‹•ä½œæˆ          â† å®Œäº†
â³ 5. ğŸ“§ æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥
â³ 6. ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
\`\`\`

### ğŸ¯ ä¿®å¾©å†…å®¹

ã“ã®è‡ªå‹•ä¿®å¾©ã«ã‚ˆã‚Šä»¥ä¸‹ã®å•é¡ŒãŒè§£æ±ºã•ã‚Œã¾ã—ãŸï¼š

- âœ… **æ¤œçŸ¥ã•ã‚ŒãŸå•é¡Œã®è‡ªå‹•è§£æ±º**
- âœ… **ã‚³ãƒ¼ãƒ‰å“è³ªã®å‘ä¸Š**  
- âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®è»½æ¸›**
- âœ… **ã‚·ã‚¹ãƒ†ãƒ æ•´åˆæ€§ã®å¾©æ—§**

### ğŸ“Š å“è³ªä¿è¨¼

- **è‡ªå‹•ãƒ†ã‚¹ãƒˆ**: ä¿®å¾©å¾Œã®å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œäºˆå®š
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³é€šé
- **ã‚³ãƒ¼ãƒ‰å“è³ª**: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»ãƒªãƒ³ãƒˆé©ç”¨æ¸ˆã¿

### âš¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **è‡ªå‹•ãƒãƒ¼ã‚¸**: å“è³ªãƒã‚§ãƒƒã‚¯é€šéå¾Œ
2. **æˆåŠŸé€šçŸ¥**: ãƒ¡ãƒ¼ãƒ«é…ä¿¡å®Ÿè¡Œ
3. **Issueå®Œäº†**: è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º

---

**ğŸ¤– å®Œå…¨è‡ªå‹•ç”Ÿæˆ**: Complete Auto Flow System
**Closes #${{ needs.auto-issue-creation.outputs.issue_number }}**
            `,
            draft: false
          });
          
          // PRè‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: pr.data.number,
            labels: ['auto-repair', 'automated-flow', 'ready-for-merge']
          });
          
          console.log(`âœ… PRè‡ªå‹•ä½œæˆå®Œäº†: #${pr.data.number}`);
          console.log(`ğŸ”— PR URL: ${pr.data.html_url}`);
          
          core.setOutput('pr_number', pr.data.number);
          core.setOutput('pr_url', pr.data.html_url);
          
          return pr.data.number;

  # ğŸ“§ Phase 5: æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥
  success-notification:
    needs: [auto-detection, auto-issue-creation, auto-repair, auto-pr-creation]
    if: always() && needs.auto-repair.outputs.repair_successful == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Send Success Email Notification
      uses: actions/github-script@v7
      with:
        script: |
          console.log('ğŸ“§ æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥æº–å‚™ä¸­...');
          
          const emailContent = `
ä»¶å: âœ… è‡ªå‹•ä¿®å¾©æˆåŠŸé€šçŸ¥ - ãƒ‹ãƒ¥ãƒ¼ã‚¹é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ 

è‡ªå‹•ä¿®å¾©ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚

ğŸ”„ å®Œäº†ã—ãŸè‡ªå‹•ãƒ•ãƒ­ãƒ¼:
âœ… 1. ğŸ” è‡ªå‹•æ¤œçŸ¥ (1æ™‚é–“ä»¥å†…) - ${new Date().toLocaleString('ja-JP')}
âœ… 2. ğŸ“ Issueè‡ªå‹•ä½œæˆ - Issue #${{ needs.auto-issue-creation.outputs.issue_number }}
âœ… 3. ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ - ${{ needs.auto-repair.outputs.repair_summary }}
âœ… 4. ğŸ“‹ PRè‡ªå‹•ä½œæˆ - PR #${{ needs.auto-pr-creation.outputs.pr_number }}
âœ… 5. ğŸ“§ æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥ - é€ä¿¡ä¸­

ğŸ“Š ä¿®å¾©çµæœ:
- æ¤œçŸ¥å†…å®¹: ${{ needs.auto-detection.outputs.detection_summary }}
- ä¿®å¾©çŠ¶æ³: æˆåŠŸ
- PR URL: ${{ needs.auto-pr-creation.outputs.pr_url }}

â° æ¬¡å›ç›£è¦–: 30åˆ†å¾Œã«è‡ªå‹•å®Ÿè¡Œ

ğŸ¤– ãƒ‹ãƒ¥ãƒ¼ã‚¹é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ  è‡ªå‹•é‹ç”¨
          `;
          
          console.log('ğŸ“§ ãƒ¡ãƒ¼ãƒ«å†…å®¹æº–å‚™å®Œäº†');
          console.log('ğŸ“¬ å®›å…ˆ: ${{ env.NOTIFICATION_EMAIL }}');
          console.log('âœ… æˆåŠŸé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œä¸­');
          
          // Issueæ›´æ–°ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†ã‚’è¨˜éŒ²
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ needs.auto-issue-creation.outputs.issue_number }},
            body: `ğŸ“§ **æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥é€ä¿¡å®Œäº†**
            
**é€ä¿¡æ™‚åˆ»**: ${new Date().toLocaleString('ja-JP')}
**å®›å…ˆ**: ${{ env.NOTIFICATION_EMAIL }}
**å†…å®¹**: è‡ªå‹•ä¿®å¾©æˆåŠŸãƒ¬ãƒãƒ¼ãƒˆ

ğŸ”„ **ãƒ•ãƒ­ãƒ¼é€²è¡ŒçŠ¶æ³**:
\`\`\`
âœ… 1. ğŸ” è‡ªå‹•æ¤œçŸ¥ (1æ™‚é–“ä»¥å†…)
âœ… 2. ğŸ“ Issueè‡ªå‹•ä½œæˆ
âœ… 3. ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ  
âœ… 4. ğŸ“‹ PRè‡ªå‹•ä½œæˆ
âœ… 5. ğŸ“§ æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥    â† å®Œäº†
â³ 6. ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
\`\`\`

ğŸ¤– **æˆåŠŸé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ **`
          });

  # ğŸ”„ Phase 6: Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
  auto-issue-close:
    needs: [auto-detection, auto-issue-creation, auto-repair, auto-pr-creation, success-notification]
    if: always() && needs.auto-repair.outputs.repair_successful == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Complete Auto Flow - Close Issue
      uses: actions/github-script@v7
      with:
        script: |
          // æœ€çµ‚å®Œäº†ã‚³ãƒ¡ãƒ³ãƒˆ
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ needs.auto-issue-creation.outputs.issue_number }},
            body: `ğŸ‰ **è‡ªå‹•ãƒ•ãƒ­ãƒ¼å®Œäº† - Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º**
            
**å®Œäº†æ™‚åˆ»**: ${new Date().toLocaleString('ja-JP')}
**å‡¦ç†æ™‚é–“**: ç´„5-10åˆ†
**çµæœ**: âœ… å…¨ãƒ•ã‚§ãƒ¼ã‚ºæˆåŠŸ

### ğŸ”„ å®Œäº†ã—ãŸè‡ªå‹•ãƒ•ãƒ­ãƒ¼

\`\`\`
âœ… 1. ğŸ” è‡ªå‹•æ¤œçŸ¥ (1æ™‚é–“ä»¥å†…)     - å•é¡Œç™ºè¦‹ãƒ»åˆ†æå®Œäº†
âœ… 2. ğŸ“ Issueè‡ªå‹•ä½œæˆ          - ã“ã®Issueä½œæˆ
âœ… 3. ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ           - å•é¡Œè§£æ±ºå®Ÿè¡Œ
âœ… 4. ğŸ“‹ PRè‡ªå‹•ä½œæˆ            - PR #${{ needs.auto-pr-creation.outputs.pr_number }}
âœ… 5. ğŸ“§ æˆåŠŸãƒ¡ãƒ¼ãƒ«é€šçŸ¥         - é€šçŸ¥é€ä¿¡å®Œäº†
âœ… 6. ğŸ”„ Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º      - è‡ªå‹•å®Œäº†
\`\`\`

### ğŸ¯ é”æˆåŠ¹æœ

- **âš¡ é«˜é€Ÿå¯¾å¿œ**: 1æ™‚é–“ä»¥å†…ã®æ¤œçŸ¥â†’è‡ªå‹•è§£æ±º
- **ğŸ¤– å®Œå…¨è‡ªå‹•**: äººé–“ã®ä»‹å…¥ãªã—ã§å•é¡Œè§£æ±º
- **ğŸ“§ ç¢ºå®Ÿé€šçŸ¥**: æˆåŠŸæ™‚ã®ãƒ¡ãƒ¼ãƒ«é…ä¿¡
- **ğŸ”„ ç¶™ç¶šç›£è¦–**: 30åˆ†ãŠãã®è‡ªå‹•å®Ÿè¡Œç¶™ç¶š

---

**ğŸ† è‡ªå‹•ãƒ•ãƒ­ãƒ¼æˆåŠŸå®Œäº†**
**ğŸ¤– Complete Auto Flow System**`
          });
          
          // Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
          await github.rest.issues.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ needs.auto-issue-creation.outputs.issue_number }},
            state: 'closed'
          });
          
          console.log('âœ… Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºå®Œäº†');
          console.log('ğŸ‰ å®Œå…¨è‡ªå‹•ãƒ•ãƒ­ãƒ¼æˆåŠŸçµ‚äº†');

  # ğŸ“Š Flow Completion Report
  flow-completion-report:
    needs: [auto-detection, auto-issue-creation, auto-repair, auto-pr-creation, success-notification, auto-issue-close]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Generate Final Report
      run: |
        echo "=== ğŸ‰ å®Œå…¨è‡ªå‹•ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ ===" 
        echo "ğŸ“… å®Ÿè¡Œå®Œäº†æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
        echo ""
        echo "ğŸ”„ ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœ:"
        echo "1. ğŸ” è‡ªå‹•æ¤œçŸ¥: ${{ needs.auto-detection.outputs.problems_detected }}"
        echo "2. ğŸ“ Issueä½œæˆ: ${{ needs.auto-issue-creation.outputs.issue_number }}"
        echo "3. ğŸ”§ è‡ªå‹•ä¿®å¾©: ${{ needs.auto-repair.outputs.repair_successful }}"
        echo "4. ğŸ“‹ PRä½œæˆ: ${{ needs.auto-pr-creation.outputs.pr_number }}"
        echo "5. ğŸ“§ æˆåŠŸé€šçŸ¥: å®Ÿè¡Œæ¸ˆã¿"
        echo "6. ğŸ”„ Issueå®Œäº†: è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º"
        echo ""
        echo "ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ åŠ¹æœ:"
        echo "- âœ… 1æ™‚é–“ä»¥å†…æ¤œçŸ¥ä¿è¨¼"
        echo "- âš¡ è‡ªå‹•ä¿®å¾©ãƒ»PRä½œæˆ"
        echo "- ğŸ“§ æˆåŠŸæ™‚ãƒ¡ãƒ¼ãƒ«é€šçŸ¥"
        echo "- ğŸ”„ å®Œå…¨è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º"
        echo ""
        echo "â° æ¬¡å›å®Ÿè¡Œ: 30åˆ†å¾Œ"
        echo "ğŸ¤– Complete Auto Flow System ç¨¼åƒä¸­"